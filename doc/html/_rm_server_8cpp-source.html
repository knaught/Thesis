<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/RmServer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000001.html">src</a></div>
<h1>RmServer.cpp</h1><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include &lt;iostream&gt;</span>
00003 <span class="preprocessor">#include "RmServer.h"</span>
00004 <span class="preprocessor">#include "RmExceptions.h"</span>
00005 
00006 
00007 RmServer::RmServer( <span class="keyword">const</span> <span class="keywordtype">short</span> portNumber )
00008 {
00009         WORD wVersionRequested = MAKEWORD(1,1);
00010         WSADATA wsaData;
00011     <span class="keywordtype">int</span> nRet = WSAStartup(wVersionRequested, &amp;wsaData);
00012         <span class="keywordflow">if</span> (wsaData.wVersion != wVersionRequested)
00013         {       
00014                 <span class="keywordflow">throw</span> <a class="code" href="struct_rm_exceptions_1_1_socket_exception.html">RmExceptions::SocketException</a>( <span class="stringliteral">"RmServer::RmServer()"</span>, <span class="stringliteral">"Wrong version"</span> );
00015         }
00016         
00017         initServer( portNumber );
00018 }
00019 
00020 
00021 RmServer::~RmServer()
00022 {
00023         closesocket( m_socket );
00024 }
00025 
00026 
00027 <span class="keywordtype">int</span> RmServer::initServer( <span class="keyword">const</span> <span class="keywordtype">short</span> portNumber )
00028 {
00029    <span class="keywordtype">int</span> nRet;
00030         <span class="keywordtype">char</span> temp[15] = <span class="stringliteral">""</span>;
00031    <span class="keywordtype">int</span> stopflag = 1;
00032 
00033         <span class="comment">//</span>
00034         <span class="comment">// Create a UDP/IP datagram socket</span>
00035         <span class="comment">//</span>
00036    m_socket = socket(AF_INET,           <span class="comment">// Address family</span>
00037                                            SOCK_DGRAM,  <span class="comment">// Socket type</span>
00038                                            IPPROTO_UDP);<span class="comment">// Protocol</span>
00039         <span class="keywordflow">if</span> (m_socket == INVALID_SOCKET)
00040         {
00041                 <span class="keywordflow">throw</span> <a class="code" href="struct_rm_exceptions_1_1_socket_exception.html">RmExceptions::SocketException</a>( <span class="stringliteral">"RmServer::initServer()"</span>, <span class="stringliteral">"Invalid socket"</span> );
00042         }
00043   
00044         
00045         <span class="comment">//</span>
00046         <span class="comment">// Fill in the address structure</span>
00047         <span class="comment">//</span>
00048         m_serverAddress.sin_family = AF_INET;
00049         m_serverAddress.sin_addr.s_addr = INADDR_ANY;           <span class="comment">// Let WinSock assign address</span>
00050         m_serverAddress.sin_port = htons(portNumber);           <span class="comment">// Use port passed from user</span>
00051 
00052         <span class="comment">//</span>
00053         <span class="comment">// Bind the name to the socket</span>
00054         <span class="comment">//</span>
00055         nRet = bind(m_socket, (LPSOCKADDR)&amp;m_serverAddress, <span class="keyword">sizeof</span>(SOCKADDR) );
00056         <span class="keywordflow">if</span> (nRet == SOCKET_ERROR)
00057         {
00058                 closesocket(m_socket);
00059                 <span class="keywordflow">throw</span> <a class="code" href="struct_rm_exceptions_1_1_socket_exception.html">RmExceptions::SocketException</a>( <span class="stringliteral">"RmServer::initServer()"</span>, <span class="stringliteral">"Unable to bind socket"</span> );
00060         }
00061 
00062 
00063         nRet = gethostname(m_szBuf, <span class="keyword">sizeof</span>(m_szBuf));
00064         <span class="keywordflow">if</span> (nRet == SOCKET_ERROR)
00065         {
00066                 closesocket(m_socket);
00067                 <span class="keywordflow">throw</span> <a class="code" href="struct_rm_exceptions_1_1_socket_exception.html">RmExceptions::SocketException</a>( <span class="stringliteral">"RmServer::initServer()"</span>, <span class="stringliteral">"Unable to get host name"</span> );
00068         }
00069 
00070         std::cout &lt;&lt; <span class="stringliteral">"Remote control server '"</span> &lt;&lt; m_szBuf &lt;&lt; <span class="stringliteral">"' waiting on port "</span> &lt;&lt; portNumber &lt;&lt; <span class="stringliteral">"\n"</span>;
00071 
00072         <span class="keywordflow">return</span> nRet;
00073 }
00074 
00075 
00076 std::string RmServer::getClientString() 
00077 {
00078         <span class="keywordtype">int</span> nLen = <span class="keyword">sizeof</span>(SOCKADDR);
00079         memset( m_szBuf, 0, <span class="keyword">sizeof</span>(m_szBuf) );
00080         <span class="keywordtype">int</span> nRet = recvfrom( m_socket, m_szBuf, <span class="keyword">sizeof</span>(m_szBuf), 0, (LPSOCKADDR)&amp;m_clientAddress, &amp;nLen );
00081         <span class="keywordflow">return</span> std::string( m_szBuf );
00082 }
00083 
00084 
00085 <span class="keywordtype">void</span> RmServer::sendReply( <span class="keyword">const</span> std::string s )
00086 {
00087         <span class="keywordtype">int</span> nRet = sendto( m_socket, s.c_str(), s.length(), 0, (LPSOCKADDR)&amp;m_clientAddress, 
00088                 <span class="keyword">sizeof</span>(SOCKADDR) );
00089         <span class="keywordflow">if</span> ( nRet == SOCKET_ERROR ) {
00090                 std::cerr &lt;&lt; <span class="stringliteral">"RmServer::sendReply() : Socket error\n"</span>;
00091         }
00092 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Apr 3 16:46:53 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
