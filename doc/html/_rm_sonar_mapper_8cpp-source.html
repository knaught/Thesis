<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/RmSonarMapper.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000001.html">src</a></div>
<h1>RmSonarMapper.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">// RmSonarMapper.cpp</span>
00002 
00003 <span class="comment">//#define ORIG_METHOD</span>
00004 
00005 <span class="preprocessor">#include &lt;iostream&gt;</span>
00006 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00007 <span class="preprocessor">#include &lt;string&gt;</span>
00008 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00009 
00010 <span class="preprocessor">#include "RmSonarMapper.h"</span>
00011 <span class="keyword">using</span> <span class="keyword">namespace </span>RmUtility;
00012 
<a name="l00013"></a><a class="code" href="class_rm_sonar_mapper.html#a0">00013</a> <span class="keywordtype">void</span> <a class="code" href="class_rm_sonar_mapper.html#a0">RmSonarMapper::handleAction</a>( ArRobot* robot )
00014 {
00015         <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> readings( robot );
00016         <a class="code" href="class_rm_sonar_mapper.html#a2">mapReadings</a>( readings );
00017         <a class="code" href="class_rm_sonar_mapper.html#b1">saveReadings</a>( readings );
00018 }
00019 
00020 
<a name="l00021"></a><a class="code" href="class_rm_sonar_mapper.html#a1">00021</a> std::string <a class="code" href="class_rm_sonar_mapper.html#a1">RmSonarMapper::mapReading</a>( <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> *reading, <span class="keyword">const</span> <span class="keywordtype">int</span> sonarNumber )
00022 {
00023         <span class="comment">// Method is called once for each individual reading</span>
00024         <span class="comment">// sonarNumber and distance specify the specific reading within the sweep</span>
00025 
00026         <span class="comment">// Buffer entire reading sweep on first call until an update is triggered</span>
00027         <span class="comment">// When an update is triggered, return one representative reading per call</span>
00028 
00029         <span class="comment">// Note the passed reading is used to test for update...not to make an update</span>
00030         <span class="comment">// It is added to the current or new collection after the test/update</span>
00031 
00032         assert( sonarNumber &gt;= 0 &amp;&amp; sonarNumber &lt;= RmPioneerController::NumSonars );
00033 
00034         <span class="keyword">static</span> std::vector&lt;SonarReading&gt; collection_;
00035         <span class="keyword">static</span> <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> *collectionReading_ = NULL;
00036 
00037         <span class="comment">// Reset state and return if no sonar reading provided</span>
00038         <span class="keywordflow">if</span> ( reading == NULL ) {
00039                 collection_.clear();
00040                 collectionReading_ = NULL;
00041                 <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00042         }
00043 
00044         <span class="comment">// Make requested reading active</span>
00045         reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o3">sonarNumber</a> = sonarNumber;
00046         reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o1">distance</a> = reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[sonarNumber];
00047 
00048         <span class="comment">// Test for max distance/turn each time first sonar in sweep is being processed</span>
00049         <span class="keywordflow">if</span> ( reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o3">sonarNumber</a> == 0 ) 
00050         {
00051                 <span class="keywordflow">switch</span> ( <a class="code" href="class_rm_sonar_mapper.html#a7">updateTriggered</a>( reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o2">robotPose</a> ) )
00052                 {
00053                         <span class="keywordflow">case</span> <a class="code" href="class_rm_sonar_mapper.html#w3w2">Turn</a>:
00054                                 collectionReading_ = &amp;collection_.back();
00055                                 collection_.clear();
00056                                 <span class="keywordflow">break</span>;
00057 
00058                         <span class="keywordflow">case</span> <a class="code" href="class_rm_sonar_mapper.html#w3w0">Distance</a>:
00059                                 collectionReading_ = <a class="code" href="class_rm_sonar_mapper.html#b0">readingFrom</a>( collection_ );
00060                                 collection_.clear();
00061                                 <span class="keywordflow">break</span>;
00062 
00063                         <span class="keywordflow">case</span> <a class="code" href="class_rm_sonar_mapper.html#w3w1">None</a>:
00064                                 collection_.push_back( *reading );
00065                                 collectionReading_ = NULL;
00066                                 <span class="keywordflow">break</span>;
00067                 }
00068         }
00069 
00070         <span class="keywordflow">return</span> collectionReading_ == NULL ? <span class="stringliteral">""</span> : <a class="code" href="class_rm_sonar_mapper.html#b2">updateUsing</a>( collectionReading_, reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o3">sonarNumber</a> );
00071 }
00072 
00073 
<a name="l00074"></a><a class="code" href="class_rm_sonar_mapper.html#a2">00074</a> <span class="keywordtype">bool</span> <a class="code" href="class_rm_sonar_mapper.html#a2">RmSonarMapper::mapReadings</a>( <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> &amp;readings )
00075 {
00076         <span class="comment">// Note the passed reading is used to test for update...not to make an update</span>
00077         <span class="comment">// It is added to the current or new collection after the test/update</span>
00078 
00079         <span class="keyword">static</span> std::vector&lt;SonarReading&gt; collection_;
00080         <span class="keywordtype">bool</span> update;
00081 
00082         <span class="keywordflow">switch</span> ( <a class="code" href="class_rm_sonar_mapper.html#a7">updateTriggered</a>( readings.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o2">robotPose</a> ) ) 
00083         {
00084                 <span class="keywordflow">case</span> <a class="code" href="class_rm_sonar_mapper.html#w3w2">Turn</a>:
00085                         <a class="code" href="class_rm_sonar_mapper.html#b2">updateUsing</a>( &amp;collection_.back() );
00086                         collection_.clear();
00087                         update = <span class="keyword">true</span>;
00088                         <span class="keywordflow">break</span>;
00089 
00090                 <span class="keywordflow">case</span> <a class="code" href="class_rm_sonar_mapper.html#w3w0">Distance</a>:
00091                         <a class="code" href="class_rm_sonar_mapper.html#b2">updateUsing</a>( <a class="code" href="class_rm_sonar_mapper.html#b0">readingFrom</a>( collection_ ) );
00092                         collection_.clear();
00093                         update = <span class="keyword">true</span>;
00094                         <span class="keywordflow">break</span>;
00095 
00096                 <span class="keywordflow">case</span> <a class="code" href="class_rm_sonar_mapper.html#w3w1">None</a>:
00097                         update = <span class="keyword">false</span>;
00098                         <span class="keywordflow">break</span>;
00099         }
00100         
00101         collection_.push_back( readings );
00102 
00103         <span class="keywordflow">return</span> update;
00104 }
00105 
00106 
<a name="l00107"></a><a class="code" href="class_rm_sonar_mapper.html#b1">00107</a> <span class="keywordtype">void</span> <a class="code" href="class_rm_sonar_mapper.html#b1">RmSonarMapper::saveReadings</a>( <span class="keyword">const</span> <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> &amp;readings )
00108 {
00109         <span class="keyword">static</span> <span class="keywordtype">char</span> buff_[3*4 + 1];
00110         <span class="keyword">const</span> <a class="code" href="struct_rm_utility_1_1_pose.html">Pose</a> &amp;pose = readings.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o2">robotPose</a>;
00111         sprintf( buff_, <span class="stringliteral">"%d %d %.6f "</span>, pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o1">theta</a> );
00112         std::string readingString( buff_ );
00113         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; RmPioneerController::NumSonars; ++i )
00114         {
00115                 sprintf( buff_, <span class="stringliteral">"%d "</span>, readings.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i] );
00116                 readingString += buff_;
00117         }
00118         readingString += <span class="stringliteral">"\n"</span>;
00119         <span class="keywordflow">if</span> ( m_sonarOut != NULL ) *m_sonarOut &lt;&lt; readingString;
00120 
00121         <span class="comment">// *** DEBUG/TEST ONLY *** //</span>
00122         std::cout &lt;&lt; readingString;
00123 }
00124 
00125 
<a name="l00126"></a><a class="code" href="class_rm_sonar_mapper.html#a7">00126</a> <a class="code" href="class_rm_sonar_mapper.html#w3">RmSonarMapper::UpdateType</a> <a class="code" href="class_rm_sonar_mapper.html#a7">RmSonarMapper::updateTriggered</a>( <span class="keyword">const</span> <a class="code" href="struct_rm_utility_1_1_pose.html">RmUtility::Pose</a> &amp;pose )
00127 {
00128         <span class="comment">// Update/test distance of travel and degree of turn</span>
00129         <span class="keyword">static</span> <span class="keywordtype">int</span> startX_ = m_settings.<a class="code" href="struct_rm_settings.html#o10">MaxCollectionDistance</a> + 1; <span class="comment">// trigger update on first run</span>
00130         <span class="keyword">static</span> <span class="keywordtype">int</span> startY_ = 0;
00131         <span class="keyword">static</span> <span class="keywordtype">double</span> startTh_ = 0.0;
00132 
00133         <span class="keyword">const</span> <span class="keywordtype">int</span> &amp;x = startX_, &amp;y = startY_; <span class="comment">// DEBUG (enables view of statics in debugger)</span>
00134         <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;th = startTh_; <span class="comment">// DEBUG</span>
00135 
00136         <span class="keyword">const</span> <span class="keywordtype">bool</span> xMax = abs( pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a> - startX_ ) &gt; m_settings.<a class="code" href="struct_rm_settings.html#o10">MaxCollectionDistance</a>;
00137         <span class="keyword">const</span> <span class="keywordtype">bool</span> yMax = abs( pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> - startY_ ) &gt; m_settings.<a class="code" href="struct_rm_settings.html#o10">MaxCollectionDistance</a>;
00138         <span class="keywordtype">double</span> deltaTh = fabs( pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o1">theta</a> - startTh_ );
00139         <span class="keywordflow">if</span> ( deltaTh &gt; 180.0 ) deltaTh = fabs( deltaTh - 360.0 );
00140         <span class="keyword">const</span> <span class="keywordtype">bool</span> thMax = deltaTh &gt; m_settings.<a class="code" href="struct_rm_settings.html#o9">MaxCollectionDegrees</a>;
00141 
00142         <a class="code" href="class_rm_sonar_mapper.html#w3">UpdateType</a> update = None;
00143         <span class="keywordflow">if</span> ( xMax || yMax ) update = Distance;
00144 <span class="preprocessor">#ifndef ORIG_METHOD</span>
00145 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( thMax ) update = Turn; <span class="comment">// takes precedence over distance</span>
00146 <span class="preprocessor">#endif</span>
00147 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( update != None )
00148         {
00149                 startX_ = pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>;
00150                 startY_ = pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>;
00151                 startTh_ = pose.<a class="code" href="struct_rm_utility_1_1_pose.html#o1">theta</a>;
00152         }
00153 
00154         <span class="keywordflow">return</span> update;
00155 }
00156 
00157 
<a name="l00158"></a><a class="code" href="class_rm_sonar_mapper.html#b0">00158</a> <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a>* <a class="code" href="class_rm_sonar_mapper.html#b0">RmSonarMapper::readingFrom</a>( std::vector&lt;SonarReading&gt; &amp;collection )
00159 {
00160         <span class="comment">// NOTE: updates triggered by degree of turn should not be convolving multiple readings</span>
00161 
00162         <span class="keywordflow">if</span> ( collection.size() == 0 ) <span class="keywordflow">return</span> NULL;
00163 
00164         <span class="comment">// Init return value</span>
00165         <span class="keyword">static</span> <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> reading_; <span class="comment">// static so can return pointer without using new</span>
00166         <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> &amp;r = reading_; <span class="comment">// DEBUG ONLY</span>
00167         reading_.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o2">robotPose</a> = collection.back().robotPose;
00168         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; RmPioneerController::NumSonars; ++i ) {
00169                 reading_.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i] = RmPioneerController::SonarRange + 1;
00170         }
00171 
00172         <span class="comment">// Update return value to shortest readings in collection</span>
00173         std::vector&lt;SonarReading&gt;::const_iterator ri; <span class="comment">// map iterator</span>
00174         <span class="keywordflow">for</span> ( ri = collection.begin(); ri != collection.end(); ++ri ) {
00175                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; RmPioneerController::NumSonars; ++i ) {
00176                         <span class="keywordflow">if</span> ( reading_.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i] &gt; ri-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i] ) {
00177                                 reading_.<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i] = ri-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i];
00178                         }
00179                 }
00180         }
00181 
00182 <span class="preprocessor">#ifdef ORIG_METHOD</span>
00183 <span class="preprocessor"></span>        reading_ = collection.front();
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186         std::cout &lt;&lt; reading_ &lt;&lt; <span class="stringliteral">"\n"</span>;
00187 
00188         <span class="keywordflow">return</span> &amp;reading_;
00189 }
00190 
00191 
<a name="l00192"></a><a class="code" href="class_rm_sonar_mapper.html#b2">00192</a> std::string <a class="code" href="class_rm_sonar_mapper.html#b2">RmSonarMapper::updateUsing</a>( <a class="code" href="struct_rm_utility_1_1_sonar_reading.html">SonarReading</a> *reading, <span class="keyword">const</span> <span class="keywordtype">int</span> sonarNumber )
00193 {
00194         <span class="keywordflow">if</span> ( reading == NULL || sonarNumber &lt; -1 || sonarNumber &gt; RmPioneerController::NumSonars ) {
00195                 <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00196         }
00197 
00198         std::string viewerString;
00199 
00200         <span class="comment">// If sonarNumber is -1, loop over all sonars </span>
00201         <span class="keywordtype">int</span> i = sonarNumber == -1 ? 0 : sonarNumber; 
00202         <span class="keywordtype">int</span> j = sonarNumber == -1 ? RmPioneerController::NumSonars : sonarNumber + 1;
00203         <span class="keywordflow">while</span> ( i &lt; j )
00204         {
00205                 reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o3">sonarNumber</a> = i;
00206                 reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o1">distance</a> = reading-&gt;<a class="code" href="struct_rm_utility_1_1_sonar_reading.html#o0">all</a>[i];
00207 
00208                 viewerString = m_bayesianGrid-&gt;<a class="code" href="class_rm_sonar_map.html#a5">update</a>( *reading );
00209                 <span class="keywordflow">if</span> ( m_remoteViewServer &amp;&amp; viewerString.length() &gt; 0 ) {
00210                         m_remoteViewServer-&gt;sendClient( viewerString );
00211                 }
00212 
00213                 ++i;
00214         }
00215 
00216         <span class="comment">// *** DEBUG/TEST ONLY *** //</span>
00217         <span class="keywordflow">if</span> ( m_sonarOut != NULL ) *m_sonarOut &lt;&lt; <span class="stringliteral">"% "</span> &lt;&lt; *reading &lt;&lt; <span class="stringliteral">"\n"</span>;
00218 
00219         <span class="keywordflow">return</span> viewerString;
00220 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Apr 3 16:46:54 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
