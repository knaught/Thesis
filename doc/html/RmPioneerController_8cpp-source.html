<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/RmPioneerController.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">src</a></div>
<h1>RmPioneerController.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">// RmPioneerController.cpp</span>
00002 
00003 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00004 
00005 <span class="preprocessor">#include &lt;vector&gt;</span>
00006 <span class="preprocessor">#include &lt;iostream&gt;</span>
00007 <span class="preprocessor">#include "RmPioneerController.h"</span>
00008 
00009 
<a name="l00010"></a><a class="code" href="classRmPioneerController.html#s0">00010</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="classRmPioneerController.html#s0">RmPioneerController::DistToSonar</a>[] = { 194.74, 217.83, 234.09, 241.30, 241.30, 234.09, 
00011         217.83, 194.74, 194.74, 217.83, 234.09, 241.30, 241.30, 234.09, 217.83, 194.74 }; <span class="comment">// millimeters</span>
00012         <span class="comment">// Calculated using x_offset and y_offset, as given in Ken Laviers' HistoGram.cpp code:</span>
00013         <span class="comment">// x_offset[] = {145,185,220,240, 240, 220, 185, 145,-145,-185,-220,-240,-240,-220,-185,-145};</span>
00014         <span class="comment">// y_offset[] = {130,115, 80, 25, -25, -80,-115,-130,-130,-115,-80, -25,  25,   80, 115, 130};</span>
00015         <span class="comment">// Because these are oriented with quadrant 1 being the left half of the forward sonar array,</span>
00016         <span class="comment">// they are converted to an orientation wherein quadrant 4 is the left half of the forward </span>
00017         <span class="comment">// sonar array:</span>
00018         <span class="comment">// x_offset[] = {-130,-115,-80,-25, 25, 80,115,130, 130, 115,  80,  25, -25, -80,-115,-130};</span>
00019         <span class="comment">// y_offset[] = { 145, 185,220,240,240,220,185,145,-145,-185,-220,-240,-240,-220,-185,-145};  </span>
00020         <span class="comment">// dist = sqrt( x^2 + y^2 ); eg: sqrt( 145^2 + 130^2 ) = 194.74</span>
<a name="l00021"></a><a class="code" href="classRmPioneerController.html#s4">00021</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="classRmPioneerController.html#s4">RmPioneerController::ThetaToSonar</a>[] = { 318.12, 328.13, 340.02, 354.05, 5.95, 19.98, 31.87, 
00022         41.88, 138.12, 148.13, 160.02, 174.05, 185.95, 199.98, 211.87, 221.88 }; <span class="comment">// in degrees</span>
00023         <span class="comment">// Calculated using DistToSonar, and the new x_offset and y_offset</span>
00024         <span class="comment">// Quadrant 4 = ASIN(x/dist)+360</span>
00025         <span class="comment">// Quadrant 1 = ASIN(x/dist)</span>
00026         <span class="comment">// Quadrant 2 = ACOS(y/dist)</span>
00027         <span class="comment">// Quadrant 3 = Quadrant 1 + 180</span>
00028         <span class="comment">// eg: for Sonar 0, in quadrant 4: th = asin(-130/194.74) + 360 = -41.88 + 360 = 318.12</span>
<a name="l00029"></a><a class="code" href="classRmPioneerController.html#s3">00029</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classRmPioneerController.html#s3">RmPioneerController::SonarTheta</a>[] = { 270, 310, 330, 350, 10, 30, 50, 90,
00030         90, 130, 150, 170, 190, 210, 230, 270 };
00031         <span class="comment">// Obtained using figure of sonar array angles in Pioneer Operations Manual:</span>
00032         <span class="comment">// { -90, -50, -30, -10, 10, 30, 50, 90, 90, 130, 150, 170, -170, -150, -130, -90 }</span>
<a name="l00033"></a><a class="code" href="classRmPioneerController.html#s2">00033</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classRmPioneerController.html#s2">RmPioneerController::SonarRange</a> = 2999;
<a name="l00034"></a><a class="code" href="classRmPioneerController.html#s1">00034</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classRmPioneerController.html#s1">RmPioneerController::NumSonars</a> = NUM_SONARS;
00035 
00036 
<a name="l00037"></a><a class="code" href="classRmPioneerController.html#a5">00037</a> <a class="code" href="classRmPioneerController.html#a5">RmPioneerController::RmPioneerController</a>( <span class="keywordtype">bool</span> wander, <span class="keywordtype">bool</span> asynch, 
00038         std::vector&lt;RmActionHandler*&gt; *actionHandlers, <span class="keywordtype">int</span> priority ) : m_connector(NULL)
00039 {
00040         <span class="keywordflow">if</span> ( (m_connectionStatus = <a class="code" href="classRmPioneerController.html#b0">initRobot</a>( wander, actionHandlers, priority )) != FAILED )
00041         {
00042                 <span class="keywordflow">if</span> ( asynch ) m_robot.runAsync( <span class="keyword">true</span> );
00043                 <span class="keywordflow">else</span> m_robot.run( <span class="keyword">true</span> );
00044         }
00045 }
00046 
00047 
<a name="l00048"></a><a class="code" href="classRmPioneerController.html#a7">00048</a> <a class="code" href="classRmPioneerController.html#a7">RmPioneerController::~RmPioneerController</a>()
00049 {
00050         Aria::shutdown(); 
00051 }
00052 
00053 
<a name="l00054"></a><a class="code" href="classRmPioneerController.html#b0">00054</a> <a class="code" href="classRmPioneerController.html#w0">RmPioneerController::ConnectionStatus</a> <a class="code" href="classRmPioneerController.html#b0">RmPioneerController::initRobot</a>( <span class="keywordtype">bool</span> wander, 
00055         std::vector&lt;RmActionHandler*&gt; *actionHandlers, <span class="keywordtype">int</span> priority )
00056 {
00057         <span class="comment">// Based on Aria 2.1-1 examples/teleop.cpp</span>
00058 
00059         <span class="keywordtype">int</span> argc = 1;
00060         <span class="keywordtype">char</span> *argv[] = { <span class="stringliteral">""</span>, <span class="stringliteral">""</span> };
00061         m_connector = <span class="keyword">new</span> ArSimpleConnector( &amp;argc, argv );
00062                 
00063         <span class="comment">// mandatory init</span>
00064         Aria::init();
00065         
00066         <span class="comment">// add the sonar to the robot</span>
00067         m_robot.addRangeDevice(&amp;m_sonar);
00068         
00069         <span class="comment">// try to connect, if we fail exit</span>
00070         <span class="keywordflow">if</span> ( !m_connector-&gt;connectRobot( &amp;m_robot ) )
00071         {
00072                 printf(<span class="stringliteral">"Could not connect to robot... exiting\n"</span>);
00073                 Aria::shutdown();
00074                 <span class="keywordflow">return</span> FAILED;
00075         }
00076         
00077         <span class="comment">// set the robots maximum velocity (sonar don't work at all well if you're</span>
00078         <span class="comment">// going faster)</span>
00079         m_robot.setAbsoluteMaxTransVel( 400 );
00080         
00081         <span class="comment">// enable the motors, disable amigobot sounds</span>
00082         m_robot.comInt( ArCommands::ENABLE, 1 );
00083         
00084         <span class="comment">// add the cations, put the limiters on top, then have the action,</span>
00085         <span class="comment">// this will keep the action from being able to drive too fast and hit</span>
00086         <span class="comment">// something</span>
00087         <span class="keywordtype">bool</span> avoid = <span class="keyword">false</span>;
00088         <span class="keywordflow">if</span> ( avoid )
00089         {
00090                 m_robot.addAction( &amp;m_recover, 100 );
00091                 m_robot.addAction( &amp;m_bumpers, 75 );
00092                 m_robot.addAction( &amp;m_avoidFront, 50 );
00093                 m_robot.addAction( &amp;m_avoidSide, 55 );
00094         }
00095 
00096         <span class="keywordflow">if</span> ( actionHandlers != NULL ) {
00097                 std::vector&lt;RmActionHandler*&gt;::iterator it( actionHandlers-&gt;begin() );
00098                 <span class="keywordflow">while</span> ( it != actionHandlers-&gt;end() ) {
00099                         m_robot.addAction( <span class="keyword">new</span> <a class="code" href="classRmActionHook.html">RmActionHook</a>( *it ), priority );
00100                         ++it;
00101                 }
00102         }
00103 
00104         <a class="code" href="classRmPioneerController.html#a6">setDriveMode</a>( wander ? WANDER : KEYDRIVE );
00105 
00106         <span class="keywordflow">return</span> SUCCESS;
00107 }
00108 
00109 
<a name="l00110"></a><a class="code" href="classRmPioneerController.html#a4">00110</a> <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a> <a class="code" href="classRmPioneerController.html#a4">RmPioneerController::pose</a>()
00111 {       
00112         <span class="keywordflow">return</span> <a class="code" href="classRmPioneerController.html#a4">pose</a>( m_robot.getPose() );
00113 }
00114 
00115 
<a name="l00116"></a><a class="code" href="classRmPioneerController.html#a6">00116</a> <span class="keywordtype">void</span> <a class="code" href="classRmPioneerController.html#a6">RmPioneerController::setDriveMode</a>( DriveMode mode )
00117 {
00118         <span class="keywordflow">if</span> ( mode == WANDER ) {
00119                 m_robot.remAction( &amp;m_keydriveAction );
00120                 m_robot.addAction( &amp;m_constantVelocity, 25 );
00121                 std::cout &lt;&lt; <span class="stringliteral">"Wandering\n"</span>;
00122         }
00123         <span class="keywordflow">else</span> {
00124                 m_robot.remAction( &amp;m_constantVelocity );
00125                 m_robot.addAction( &amp;m_keydriveAction, 45 );
00126                 std::cout &lt;&lt; <span class="stringliteral">"Keydrive\n"</span>;
00127         }
00128 }
00129 
00130 
<a name="l00131"></a><a class="code" href="classRmPioneerController.html#e0">00131</a> <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a> <a class="code" href="classRmPioneerController.html#a4">RmPioneerController::pose</a>( ArPose&amp; arPose )
00132 {
00133         <span class="keywordtype">double</span> th = <a class="code" href="classRmPioneerController.html#f0">polarTheta</a>( arPose.getTh() );
00134         assert( th &gt;= 0 &amp;&amp; th &lt; 360 );
00135         <span class="keywordflow">return</span> <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a>( -arPose.getY(), arPose.getX(), th );
00136 }
00137 
00138 
<a name="l00139"></a><a class="code" href="classRmPioneerController.html#e1">00139</a> <a class="code" href="structRmUtility_1_1MappedSonarReading.html">RmUtility::MappedSonarReading</a> <a class="code" href="classRmPioneerController.html#e1">RmPioneerController::rangeReading</a>( <span class="keyword">const</span> <a class="code" href="structRmUtility_1_1SonarReading.html">RmUtility::SonarReading</a>&amp; reading )
00140 {
00141         <span class="comment">// Sonar pose</span>
00142         <span class="comment">// Location of robot is relative to its center point and heading</span>
00143         <span class="keywordtype">double</span> sth = reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o2">robotPose</a>.theta + <a class="code" href="classRmPioneerController.html#s4">ThetaToSonar</a>[reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a>];
00144         <span class="keywordflow">if</span> ( sth &gt;= 360 ) sth -= 360;
00145         <a class="code" href="classRmUtility_1_1Coord.html">RmUtility::Coord</a> sonarCoord( 
00146                 reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o2">robotPose</a>.coord.mappedTo( sth, <a class="code" href="classRmPioneerController.html#s0">DistToSonar</a>[reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a>] ) );
00147         <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a> sonarPose( sonarCoord, sth );
00148 
00149         <span class="comment">// Object coord</span>
00150         <span class="comment">// Location of the sensed object is relative to the sonar location and robot heading</span>
00151         <a class="code" href="classRmUtility_1_1Coord.html">RmUtility::Coord</a> objectCoord( sonarPose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.mappedTo( reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o2">robotPose</a>.theta + 
00152                 <a class="code" href="classRmPioneerController.html#s3">SonarTheta</a>[reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a>], reading.<a class="code" href="structRmUtility_1_1SonarReading.html#o1">distance</a> ) );
00153 
00154         <span class="keywordflow">return</span> <a class="code" href="structRmUtility_1_1MappedSonarReading.html">RmUtility::MappedSonarReading</a>( reading, sonarPose, objectCoord );
00155 }
00156 
00157 
<a name="l00158"></a><a class="code" href="classRmPioneerController.html#f0">00158</a> <span class="keywordtype">double</span> <a class="code" href="classRmPioneerController.html#f0">RmPioneerController::polarTheta</a>( <span class="keywordtype">double</span> arTheta )
00159 {
00160         <span class="keywordtype">double</span> theta = arTheta &lt; 0 ? arTheta * -1 : arTheta == 0 ? 0 : 360 - arTheta;
00161         <span class="keywordflow">if</span> ( theta &gt;= 360 ) theta -= 360;
00162 
00163         <span class="keywordflow">return</span> theta;
00164 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 1 23:40:03 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
