<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/RmSonarMapper.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">src</a></div>
<h1>RmSonarMapper.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">// RmSonarMapper.cpp</span>
00002 
00003 
00004 <span class="preprocessor">#include &lt;iostream&gt;</span>
00005 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00006 <span class="preprocessor">#include &lt;string&gt;</span>
00007 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00008 
00009 <span class="preprocessor">#include "RmSonarMapper.h"</span>
00010 <span class="keyword">using</span> <span class="keyword">namespace </span>RmUtility;
00011 
<a name="l00012"></a><a class="code" href="classRmSonarMapper.html#a0">00012</a> <span class="keywordtype">void</span> <a class="code" href="classRmSonarMapper.html#a0">RmSonarMapper::handleAction</a>( ArRobot* robot )
00013 {
00014         <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> readings( robot );
00015         <a class="code" href="classRmSonarMapper.html#a2">mapReadings</a>( readings );
00016         <a class="code" href="classRmSonarMapper.html#b1">saveReadings</a>( robot-&gt;getPose(), readings );
00017 }
00018 
00019 
<a name="l00020"></a><a class="code" href="classRmSonarMapper.html#a1">00020</a> std::string <a class="code" href="classRmSonarMapper.html#a1">RmSonarMapper::mapReading</a>( <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> *reading, <span class="keyword">const</span> <span class="keywordtype">int</span> sonarNumber )
00021 {
00022         <span class="comment">// Method is called once for each individual reading</span>
00023         <span class="comment">// sonarNumber and distance specify the specific reading within the sweep</span>
00024 
00025         <span class="comment">// Buffer entire reading sweep on first call until an update is triggered</span>
00026         <span class="comment">// When an update is triggered, return one representative reading per call</span>
00027 
00028         <span class="comment">// Note the passed reading is used to test for update...not to make an update</span>
00029         <span class="comment">// It is added to the current or new collection after the test/update</span>
00030 
00031         assert( sonarNumber &gt;= 0 &amp;&amp; sonarNumber &lt;= RmPioneerController::NumSonars );
00032 
00033         <span class="keyword">static</span> std::vector&lt;SonarReading&gt; collection_;
00034         <span class="keyword">static</span> <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> *collectionReading_ = NULL;
00035 
00036         <span class="comment">// Reset state and return if no sonar reading provided</span>
00037         <span class="keywordflow">if</span> ( reading == NULL ) {
00038                 collection_.clear();
00039                 collectionReading_ = NULL;
00040                 <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00041         }
00042 
00043         <span class="comment">// Make requested reading active</span>
00044         reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a> = sonarNumber;
00045         reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o1">distance</a> = reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[sonarNumber];
00046 
00047         <span class="comment">// Test for max distance/turn each time first sonar in sweep is being processed</span>
00048         <span class="keywordflow">if</span> ( reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a> == 0 ) 
00049         {
00050                 <span class="keywordflow">switch</span> ( <a class="code" href="classRmSonarMapper.html#a7">updateTriggered</a>( reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o2">robotPose</a> ) )
00051                 {
00052                         <span class="keywordflow">case</span> <a class="code" href="classRmSonarMapper.html#w3w2">Turn</a>:
00053                                 collectionReading_ = &amp;collection_.back();
00054                                 collection_.clear();
00055                                 <span class="keywordflow">break</span>;
00056 
00057                         <span class="keywordflow">case</span> <a class="code" href="classRmSonarMapper.html#w3w0">Distance</a>:
00058                                 collectionReading_ = <a class="code" href="classRmSonarMapper.html#b0">readingFrom</a>( collection_ );
00059                                 collection_.clear();
00060                                 <span class="keywordflow">break</span>;
00061 
00062                         <span class="keywordflow">case</span> <a class="code" href="classRmSonarMapper.html#w3w1">None</a>:
00063                                 collectionReading_ = NULL;
00064                                 <span class="keywordflow">break</span>;
00065                 }
00066 
00067                 collection_.push_back( *reading );
00068         }
00069 
00070         <span class="keywordflow">return</span> collectionReading_ == NULL ? <span class="stringliteral">""</span> : <a class="code" href="classRmSonarMapper.html#b2">updateUsing</a>( collectionReading_, reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a> );
00071 }
00072 
00073 
<a name="l00074"></a><a class="code" href="classRmSonarMapper.html#a2">00074</a> <span class="keywordtype">bool</span> <a class="code" href="classRmSonarMapper.html#a2">RmSonarMapper::mapReadings</a>( <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> &amp;readings )
00075 {
00076         <span class="comment">// Note the passed reading is used to test for update...not to make an update</span>
00077         <span class="comment">// It is added to the current or new collection after the test/update</span>
00078 
00079         <span class="keyword">static</span> std::vector&lt;SonarReading&gt; collection_;
00080         <span class="keywordtype">bool</span> update;
00081 
00082         <span class="keywordflow">switch</span> ( <a class="code" href="classRmSonarMapper.html#a7">updateTriggered</a>( readings.<a class="code" href="structRmUtility_1_1SonarReading.html#o2">robotPose</a> ) ) 
00083         {
00084                 <span class="keywordflow">case</span> <a class="code" href="classRmSonarMapper.html#w3w2">Turn</a>:
00085                         <a class="code" href="classRmSonarMapper.html#b2">updateUsing</a>( &amp;collection_.back() );
00086                         collection_.clear();
00087                         update = <span class="keyword">true</span>;
00088                         <span class="keywordflow">break</span>;
00089 
00090                 <span class="keywordflow">case</span> <a class="code" href="classRmSonarMapper.html#w3w0">Distance</a>:
00091                         <a class="code" href="classRmSonarMapper.html#b2">updateUsing</a>( <a class="code" href="classRmSonarMapper.html#b0">readingFrom</a>( collection_ ) );
00092                         collection_.clear();
00093                         update = <span class="keyword">true</span>;
00094                         <span class="keywordflow">break</span>;
00095 
00096                 <span class="keywordflow">case</span> <a class="code" href="classRmSonarMapper.html#w3w1">None</a>:
00097                         update = <span class="keyword">false</span>;
00098                         <span class="keywordflow">break</span>;
00099         }
00100 
00101         collection_.push_back( readings );
00102 
00103         <span class="keywordflow">return</span> update;
00104 }
00105 
00106 
<a name="l00107"></a><a class="code" href="classRmSonarMapper.html#b1">00107</a> <span class="keywordtype">void</span> <a class="code" href="classRmSonarMapper.html#b1">RmSonarMapper::saveReadings</a>( <span class="keyword">const</span> ArPose &amp;arPose, <span class="keyword">const</span> <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> &amp;readings )
00108 {
00109         <span class="keywordflow">if</span> ( m_sonarOut == NULL ) <span class="keywordflow">return</span>;
00110 
00111         <span class="keyword">static</span> <span class="keywordtype">char</span> buff_[3*4 + 1];
00112         <span class="keyword">const</span> <a class="code" href="structRmUtility_1_1Pose.html">Pose</a> pose( arPose.getX(), arPose.getY(), arPose.getTh() );
00113         sprintf( buff_, <span class="stringliteral">"%d %d %.6f "</span>, pose.coord.x, pose.coord.y, pose.theta );
00114                 <span class="comment">// for backward compatability with thesis data,</span>
00115                 <span class="comment">// must retain the assumption that the data file contains raw Aria pose info</span>
00116         std::string readingString( buff_ );
00117 
00118         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; RmPioneerController::NumSonars; ++i )
00119         {
00120                 sprintf( buff_, <span class="stringliteral">"%d "</span>, readings.<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i] );
00121                 readingString += buff_;
00122         }
00123         readingString += <span class="stringliteral">"\n"</span>;
00124 
00125         *m_sonarOut &lt;&lt; readingString;
00126 }
00127 
00128 
<a name="l00129"></a><a class="code" href="classRmSonarMapper.html#a7">00129</a> <a class="code" href="classRmSonarMapper.html#w3">RmSonarMapper::UpdateType</a> <a class="code" href="classRmSonarMapper.html#a7">RmSonarMapper::updateTriggered</a>( <span class="keyword">const</span> <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a> &amp;pose )
00130 {
00131         <span class="comment">// Update/test distance of travel and degree of turn</span>
00132         <span class="keyword">static</span> <span class="keywordtype">int</span> startX_ = 0; <span class="comment">// trigger update on first run</span>
00133         <span class="keyword">static</span> <span class="keywordtype">int</span> startY_ = 0;
00134         <span class="keyword">static</span> <span class="keywordtype">double</span> startTh_ = 0.0;
00135 
00136         <span class="keyword">const</span> <span class="keywordtype">bool</span> xMax = abs( pose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> - startX_ ) &gt;= m_settings.<a class="code" href="structRmSettings.html#o10">MaxCollectionDistance</a>;
00137         <span class="keyword">const</span> <span class="keywordtype">bool</span> yMax = abs( pose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> - startY_ ) &gt;= m_settings.<a class="code" href="structRmSettings.html#o10">MaxCollectionDistance</a>;
00138         <span class="keywordtype">double</span> deltaTh = fabs( pose.<a class="code" href="structRmUtility_1_1Pose.html#o1">theta</a> - startTh_ );
00139         <span class="keywordflow">if</span> ( deltaTh &gt; 180.0 ) deltaTh = fabs( deltaTh - 360.0 );
00140         <span class="keyword">const</span> <span class="keywordtype">bool</span> thMax = deltaTh &gt;= m_settings.<a class="code" href="structRmSettings.html#o9">MaxCollectionDegrees</a>;
00141 
00142         <a class="code" href="classRmSonarMapper.html#w3">UpdateType</a> update = None;
00143         <span class="keywordflow">if</span> ( xMax || yMax ) update = Distance;
00144         <span class="keywordflow">if</span> ( thMax ) update = Turn; <span class="comment">// takes precedence over distance</span>
00145 
00146         <span class="keywordflow">if</span> ( update != None )
00147         {
00148                 startX_ = pose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> / m_settings.<a class="code" href="structRmSettings.html#o10">MaxCollectionDistance</a> * m_settings.<a class="code" href="structRmSettings.html#o10">MaxCollectionDistance</a>;
00149                 startY_ = pose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> / m_settings.<a class="code" href="structRmSettings.html#o10">MaxCollectionDistance</a> * m_settings.<a class="code" href="structRmSettings.html#o10">MaxCollectionDistance</a>;
00150                 startTh_ = pose.<a class="code" href="structRmUtility_1_1Pose.html#o1">theta</a> / m_settings.<a class="code" href="structRmSettings.html#o9">MaxCollectionDegrees</a> * m_settings.<a class="code" href="structRmSettings.html#o9">MaxCollectionDegrees</a>;
00151         }
00152 
00153         <span class="keywordflow">return</span> update;
00154 }
00155 
00156 
<a name="l00157"></a><a class="code" href="classRmSonarMapper.html#b0">00157</a> <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a>* <a class="code" href="classRmSonarMapper.html#b0">RmSonarMapper::readingFrom</a>( std::vector&lt;SonarReading&gt; &amp;collection )
00158 {
00159         <span class="comment">// NOTE: updates triggered by degree of turn should not be convolving multiple readings</span>
00160 
00161         <span class="keywordflow">if</span> ( collection.size() == 0 ) {
00162                 std::cerr &lt;&lt; <span class="stringliteral">"RmSonarMapper::readingFrom() : collection.size() == 0\n"</span>;
00163                 <span class="keywordflow">return</span> NULL;
00164         }
00165 
00166         <span class="comment">// Init return value</span>
00167         <span class="keyword">static</span> <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> reading_; <span class="comment">// static so can return pointer without using new</span>
00168         reading_.<a class="code" href="structRmUtility_1_1SonarReading.html#o2">robotPose</a> = collection.back().robotPose;
00169         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; RmPioneerController::NumSonars; ++i ) {
00170                 reading_.<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i] = RmPioneerController::SonarRange + 1;
00171         }
00172 
00173         <span class="comment">// Update return value to shortest readings in collection</span>
00174         std::vector&lt;SonarReading&gt;::const_iterator ri; <span class="comment">// map iterator</span>
00175         <span class="keywordflow">for</span> ( ri = collection.begin(); ri != collection.end(); ++ri ) {
00176                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; RmPioneerController::NumSonars; ++i ) {
00177                         <span class="keywordflow">if</span> ( reading_.<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i] &gt; ri-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i] ) {
00178                                 reading_.<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i] = ri-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i];
00179                         }
00180                 }
00181         }
00182 
00183         <span class="keywordflow">return</span> &amp;reading_;
00184 }
00185 
00186 
<a name="l00187"></a><a class="code" href="classRmSonarMapper.html#b2">00187</a> std::string <a class="code" href="classRmSonarMapper.html#b2">RmSonarMapper::updateUsing</a>( <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a> *reading, <span class="keyword">const</span> <span class="keywordtype">int</span> sonarNumber )
00188 {
00189         <span class="keywordflow">if</span> ( reading == NULL || sonarNumber &lt; -1 || sonarNumber &gt; RmPioneerController::NumSonars ) {
00190                 <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00191         }
00192 
00193         std::string viewerString;
00194 
00195         <span class="comment">// If sonarNumber is -1, loop over all sonars </span>
00196         <span class="keywordtype">int</span> i = sonarNumber == -1 ? 0 : sonarNumber; 
00197         <span class="keywordtype">int</span> j = sonarNumber == -1 ? RmPioneerController::NumSonars : sonarNumber + 1;
00198         <span class="keywordflow">while</span> ( i &lt; j )
00199         {
00200                 reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o3">sonarNumber</a> = i;
00201                 reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o1">distance</a> = reading-&gt;<a class="code" href="structRmUtility_1_1SonarReading.html#o0">all</a>[i];
00202 
00203                 viewerString = m_bayesianGrid-&gt;<a class="code" href="classRmSonarMap.html#a5">update</a>( *reading );
00204 
00205                 <span class="keywordflow">if</span> ( m_remoteViewServer &amp;&amp; viewerString.length() &gt; 0 ) {
00206                         m_remoteViewServer-&gt;<a class="code" href="classRmServer.html#a2">sendClientReply</a>( viewerString );
00207                 }
00208 
00209                 ++i;
00210         }
00211 
00212         <span class="keywordflow">return</span> viewerString;
00213 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 1 23:40:03 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
