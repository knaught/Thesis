<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/RmBayesCertaintyGrid.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000001.html">src</a></div>
<h1>RmBayesCertaintyGrid.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;cmath&gt;</span>
00002 <span class="preprocessor">#include &lt;iostream&gt;</span>
00003 <span class="preprocessor">#include "RmBayesCertaintyGrid.h"</span>
00004 <span class="keyword">using</span> <a class="code" href="class_rm_utility_1_1_coord.html">RmUtility::Coord</a>;
00005 <span class="preprocessor">#include "RmExceptions.h"</span>
00006 
00007 <span class="preprocessor">#define _CPP_EXTERN</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#include "../polygon/polygon.h"</span>
00009 
<a name="l00010"></a><a class="code" href="class_rm_bayes_certainty_grid.html#s0">00010</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="class_rm_bayes_certainty_grid.html#s0">RmBayesCertaintyGrid::InitVal</a> = 0.5f;
00011 
00012 
<a name="l00013"></a><a class="code" href="class_rm_bayes_certainty_grid.html#a6">00013</a> <span class="keyword">const</span> std::string <a class="code" href="class_rm_bayes_certainty_grid.html#a7">RmBayesCertaintyGrid::update</a>( <span class="keyword">const</span> <a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html">RmUtility::MappedSonarReading</a>&amp; mr )
00014 {
00015         <span class="comment">// Text that goes to the log and map viewer application</span>
00016         std::string logEntry;
00017 
00018 
00020         <span class="comment">// Ignore "disabled" sonars</span>
00021         <span class="keywordflow">if</span> ( !m_settings-&gt;<a class="code" href="struct_rm_settings.html#o3">EnabledSonars</a>[mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.sonarNumber] ) <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00022 
00023 
00025         <span class="comment">// Ignore or convert out of range readings</span>
00026 
00027         <span class="keywordtype">int</span> rangeReading = mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.distance;
00028         <span class="keywordtype">bool</span> isOutOfRange = <span class="keyword">false</span>; <span class="comment">// for use by cone model</span>
00029 
00030         <span class="comment">// Because Region I extends beyond the actual range reading by REGION_I_HALFWIDTH,</span>
00031         <span class="comment">// ensure that its outer boundary is within the range of the sonar because</span>
00032         <span class="comment">// RmBayesSonarModel::prOccupiedGivenSn() expects r &lt;= R</span>
00033         <span class="keywordflow">if</span> ( rangeReading &gt; RmPioneerController::SonarRange - m_settings-&gt;<a class="code" href="struct_rm_settings.html#o17">RegionIHalfwidth</a> ) 
00034         { 
00035                 <span class="comment">// Cone model processes </span>
00036                 <span class="keywordflow">if</span> ( m_settings-&gt;<a class="code" href="struct_rm_settings.html#o6">IgnoreOutOfRange</a> ) { <span class="comment">// &amp;&amp; m_settings-&gt;SonarModel != RmUtility::Cone ) {</span>
00037                         <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00038                 }
00039                 isOutOfRange = <span class="keyword">true</span>;
00040                 rangeReading = m_settings-&gt;<a class="code" href="struct_rm_settings.html#o15">OutOfRangeConversion</a>;
00041         }
00042 
00043 
00045         <span class="comment">// Build sonar regions</span>
00046         <span class="comment">//</span>
00047         <span class="comment">// Region I is that surrounding the object detected at some distance along the sonar axis.</span>
00048         <span class="comment">// Region II is that which lies between Region I and the origin of the sonar gcSonar.</span>
00049         <span class="comment">//               F</span>
00050         <span class="comment">//         E     O     G      Region I: B-C-D-G-F-E</span>
00051         <span class="comment">//               C            Object (range reading)</span>
00052         <span class="comment">//           B       D</span>
00053         <span class="comment">//                            Region II: A-B-C-D</span>
00054         <span class="comment">//</span>
00055         <span class="comment">//               A            Origin (sonar position)</span>
00056 
00057         <span class="comment">// Convert world coordinates to grid coordinates</span>
00058         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> gcRobot = <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.robotPose.coord );
00059         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> gcSonar = <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o2">sonarPose</a>.coord );
00060         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> gcObject = <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o0">objectCoord</a> );
00061 
00062         <span class="comment">// Find left and right boundaries of cone</span>
00063         <span class="keywordtype">double</span> thAxis = mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.robotPose.theta + 
00064                 RmPioneerController::SonarTheta[mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.sonarNumber];
00065         <span class="keywordflow">if</span> ( thAxis &gt;= 360 ) thAxis -= 360;
00066         <span class="keyword">const</span> <span class="keywordtype">double</span> thLeft = thAxis - m_settings-&gt;<a class="code" href="struct_rm_settings.html#o1">Beta</a>;
00067         <span class="keyword">const</span> <span class="keywordtype">double</span> thRight = thAxis + m_settings-&gt;<a class="code" href="struct_rm_settings.html#o1">Beta</a>;
00068         <span class="keyword">const</span> <span class="keywordtype">double</span> d1 = rangeReading - m_settings-&gt;<a class="code" href="struct_rm_settings.html#o17">RegionIHalfwidth</a>; <span class="comment">// dist to region I</span>
00069         <span class="keyword">const</span> <span class="keywordtype">double</span> d3 = rangeReading + m_settings-&gt;<a class="code" href="struct_rm_settings.html#o17">RegionIHalfwidth</a>; <span class="comment">// dist to region III</span>
00070 
00071         <span class="comment">// Create points of polygons defining regions</span>
00072         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> wcSonar( mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o2">sonarPose</a>.coord );
00073         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> a( gcSonar );
00074         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> b( <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( wcSonar.mappedTo( thLeft, d1 ) ) );
00075         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> c( <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( wcSonar.mappedTo( thAxis, d1 ) ) );
00076         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> d( <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( wcSonar.mappedTo( thRight, d1 ) ) );
00077         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> e( <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( wcSonar.mappedTo( thLeft, d3 ) ) );
00078         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> f( <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o0">objectCoord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#a5">mappedTo</a>( thAxis, d3 - d1 ) ) );
00079                 <span class="comment">// See note in updateAxisCell()</span>
00080         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> g( <a class="code" href="class_rm_bayes_certainty_grid.html#b1">gridCoord</a>( wcSonar.mappedTo( thRight, d3 ) ) );
00081 
00082         <span class="comment">// Form the polygons for use by the polygon fill routine</span>
00083         <span class="comment">// NOTE! The order of these points is *extremely* important</span>
00084         <span class="comment">// They are a "connect-the-dots" representation of the two regional polygons</span>
00085         <span class="keyword">struct </span>Point regionI[] = 
00086                 { {b.x, b.y}, {c.x, c.y}, {d.x, d.y}, {g.x, g.y}, {f.x, f.y}, {e.x, e.y} };
00087         <span class="keyword">struct </span>Point regionII[] = { {a.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, a.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>}, {b.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, b.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>}, {c.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, c.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>}, {d.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, d.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>} };
00088 
00089 
00091         <span class="comment">// Build logfile entries</span>
00092 
00093         <span class="keyword">static</span> <span class="keywordtype">char</span> buff[77]; <span class="comment">// sprintf buffer that accommodates 19 numbers with at most 3 digits, </span>
00094                 <span class="comment">// each followed by 1 whitespace character, terminated by null (19 * 4 + 1)</span>
00095 
00096         <span class="comment">// Pose and range data</span>
00097         <span class="keyword">const</span> <a class="code" href="struct_rm_utility_1_1_pose.html">RmUtility::Pose</a> globalPose = <a class="code" href="struct_rm_utility_1_1_pose.html">RmUtility::Pose</a>( gcRobot, mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.robotPose.theta );
00098         sprintf( buff, <span class="stringliteral">"%d %d %d %d %d\n"</span>, globalPose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, globalPose.<a class="code" href="struct_rm_utility_1_1_pose.html#o0">coord</a>.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, 
00099                 static_cast&lt;int&gt;(globalPose.<a class="code" href="struct_rm_utility_1_1_pose.html#o1">theta</a>), mr.<a class="code" href="struct_rm_utility_1_1_mapped_sonar_reading.html#o1">reading</a>.sonarNumber, rangeReading );
00100         logEntry.append( buff );
00101 
00102         <span class="comment">// Region fill data</span>
00103         std::string regionFill;
00104         <span class="keywordflow">switch</span>( m_settings-&gt;<a class="code" href="struct_rm_settings.html#o19">SonarModel</a> )
00105         {
00106                 <span class="keywordflow">case</span> RmUtility::SingleCell:
00107 
00108                         regionFill.append( <a class="code" href="class_rm_bayes_certainty_grid.html#b3">updateCell</a>( 
00109                                 gcObject, static_cast&lt;double&gt;(rangeReading) / m_settings-&gt;<a class="code" href="struct_rm_settings.html#o2">CellSize</a> ) );
00110                         <span class="keywordflow">break</span>;
00111 
00112                 <span class="keywordflow">case</span> RmUtility::AcousticAxis:
00113 
00114                         regionFill.append( <a class="code" href="class_rm_bayes_certainty_grid.html#b2">updateAxis</a>( gcSonar, gcObject, f ) );
00115                         <span class="keywordflow">break</span>;
00116 
00117                 <span class="keywordflow">case</span> RmUtility::Cone:
00118 
00119                         PointListHeader pointListI = { 6, regionI };
00120                         PointListHeader pointListII = { 4, regionII };
00121 
00122                         <span class="keywordflow">try</span> {
00123                                 <span class="keywordflow">if</span> ( !isOutOfRange ) {
00124                                         regionFill.append( 
00125                                                 <a class="code" href="class_rm_bayes_certainty_grid.html#b4">updateRegion</a>( RmBayesSonarModel::RegionI, &amp;pointListI, gcSonar, thAxis ) );
00126                                 }
00127                                 regionFill.append( 
00128                                         <a class="code" href="class_rm_bayes_certainty_grid.html#b4">updateRegion</a>( RmBayesSonarModel::RegionII, &amp;pointListII, gcSonar, thAxis ) );
00129                         }
00130                         <span class="keywordflow">catch</span>( <a class="code" href="struct_rm_exceptions_1_1_exception.html">RmExceptions::Exception</a> e ) {
00131                                 std::cerr &lt;&lt; <span class="stringliteral">"Exception: "</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00132                         }
00133                         <span class="keywordflow">break</span>;
00134         }
00135         <span class="keywordflow">if</span> ( regionFill.length() == 0 ) <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00136 
00137         logEntry.append( regionFill );
00138         logEntry.append( <span class="stringliteral">"\n"</span> );
00139 
00140 <span class="preprocessor">#ifdef __DLL_MAPPER</span>
00141 <span class="preprocessor"></span><span class="comment">//      fireMapUpdateEvent( logEntry );</span>
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span>
00144         <span class="keywordflow">return</span> logEntry;
00145 }
00146 
00147 
<a name="l00148"></a><a class="code" href="class_rm_bayes_certainty_grid.html#b3">00148</a> std::string <a class="code" href="class_rm_bayes_certainty_grid.html#b3">RmBayesCertaintyGrid::updateCell</a>( <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; gcObject, <span class="keywordtype">double</span> distance )
00149 {
00150         <span class="comment">// Update grid</span>
00151         <span class="keywordtype">float</span> &amp;pr = <a class="code" href="class_rm_mutable_cartesian_grid.html#a18">valueAt</a>( gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> );
00152         pr = m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#a0">prOccupiedGivenSn</a>( pr, RmBayesSonarModel::RegionI, distance );
00153 
00154         <span class="comment">// Log string</span>
00155         <span class="keyword">static</span> <span class="keywordtype">char</span> buff[18]; <span class="comment">// two signed 3-digit numbers and one 6-digit float, </span>
00156                 <span class="comment">// separated by one whitespace, terminated with null (2*5 + 1*7 + 1)</span>
00157 
00158         sprintf( buff, <span class="stringliteral">"%d %d %.4f;"</span>, gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, pr );
00159         assert( strlen( buff ) &lt;= 17 );
00160         <span class="keywordflow">return</span> std::string( buff );
00161 }
00162 
00163 
00164 
<a name="l00165"></a><a class="code" href="class_rm_bayes_certainty_grid.html#b2">00165</a> std::string <a class="code" href="class_rm_bayes_certainty_grid.html#b2">RmBayesCertaintyGrid::updateAxis</a>( <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; gcSonar, <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; gcObject, 
00166         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">RmUtility::Coord</a>&amp; gcRegionIII )
00167 {
00168         <span class="comment">// Note: This routine maps from sonar-&gt;object-&gt;regionIII rather than sonar-&gt;regionIII</span>
00169         <span class="comment">// because line sonar-&gt;object does not always align with that drawn from sonar-&gt;regionIII</span>
00170         <span class="comment">// (due to the low granularity of the grid-world coordinates)</span>
00171         <span class="comment">// It is important that these align for purposes of filtering obstructed readings</span>
00172         <span class="comment">// (see RmGlobalMap::obstructionBetween())</span>
00173 
00174         std::string logEntry;
00175 
00176         <span class="comment">// Sonar to object</span>
00177         <span class="keywordflow">for</span> ( <span class="keyword">struct </span>PointList* linePointList = FillLine( gcSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> ); 
00178            linePointList; linePointList = linePointList-&gt;next )
00179         {
00180                 logEntry.append( updateAxisCell( gcSonar, gcObject, 
00181                         <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>( linePointList-&gt;point.X, linePointList-&gt;point.Y ) ) );
00182         }
00183 
00184         <span class="comment">// Object to Region III</span>
00185         <span class="keywordflow">for</span> ( linePointList = FillLine( gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcObject.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, gcRegionIII.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcRegionIII.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> ); 
00186            linePointList; linePointList = linePointList-&gt;next )
00187         {
00188                 logEntry.append( updateAxisCell( gcSonar, gcObject, 
00189                         <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>( linePointList-&gt;point.X, linePointList-&gt;point.Y ) ) );
00190         }
00191 
00192         <span class="keywordflow">return</span> logEntry;
00193 }
00194 
00195 
00196 
00197 std::string RmBayesCertaintyGrid::updateAxisCell( <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> &amp;gcSonar, <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> &amp;gcObject, 
00198         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> &amp;gcCell )
00199 {
00200         <span class="keyword">static</span> <span class="keywordtype">char</span> buff[18]; <span class="comment">// sprintf buffer that accommodates two 3-digit signed numbers</span>
00201                 <span class="comment">// and one 6-digit float, each followed by one character, terminated with null </span>
00202                 <span class="comment">// (2*5 + 1*7 + 1) = 18</span>
00203 
00204         RmBayesSonarModel::Region region = <a class="code" href="class_rm_bayes_certainty_grid.html#b0">cellRegion</a>( gcSonar, gcObject, gcCell );
00205         <span class="keywordflow">if</span> ( region &lt;= RmBayesSonarModel::RegionI )
00206         {
00207                 <span class="keywordtype">int</span> dx = gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a> - gcSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>;
00208                 <span class="keywordtype">int</span> dy = gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> - gcSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>;
00209                 <span class="keywordtype">double</span> r = sqrt( pow( dx, 2 ) + pow( dy, 2 ) );
00210                 <span class="keywordflow">if</span> ( r &gt; m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#o0">R</a> ) r = m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#o0">R</a>;
00211                 <span class="keywordflow">try</span> 
00212                 {
00213                         <span class="keywordtype">float</span> &amp;pr = <a class="code" href="class_rm_mutable_cartesian_grid.html#a18">valueAt</a>( gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> );
00214                         pr = m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#a0">prOccupiedGivenSn</a>( pr, region, r );
00215 
00216                         sprintf( buff, <span class="stringliteral">"%d %d %.4f;"</span>, gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, pr );
00217                         assert( strlen( buff ) &lt;= 17 );
00218                 }
00219                 <span class="keywordflow">catch</span>( <a class="code" href="struct_rm_exceptions_1_1_exception.html">RmExceptions::Exception</a> e ) {
00220                         std::cerr &lt;&lt; <span class="stringliteral">"Exception caught in RmBayesCertaintyGrid::updateAxisCell(): "</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00221                 }
00222         }
00223 
00224         <span class="keywordflow">return</span> std::string( buff );
00225 }
00226 
00227 
00228 
<a name="l00229"></a><a class="code" href="class_rm_bayes_certainty_grid.html#b4">00229</a> std::string <a class="code" href="class_rm_bayes_certainty_grid.html#b4">RmBayesCertaintyGrid::updateRegion</a>( <span class="keyword">const</span> RmBayesSonarModel::Region region, 
00230         <span class="keyword">struct</span> PointListHeader* polygon, <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; gcSonar, <span class="keywordtype">double</span> thAxis )
00231 {
00232         <span class="keywordflow">if</span> ( region != RmBayesSonarModel::RegionI &amp;&amp; region != RmBayesSonarModel::RegionII ) 
00233                 <span class="keywordflow">throw</span> <a class="code" href="struct_rm_exceptions_1_1_invalid_parameter_exception.html">RmExceptions::InvalidParameterException</a>( <span class="stringliteral">"RmBayesCertaintyGrid::updateRegion"</span>, 
00234                         <span class="stringliteral">"Invalid region specification"</span> );
00235         <span class="keywordflow">if</span> ( polygon == 0 ) 
00236                 <span class="keywordflow">throw</span> <a class="code" href="struct_rm_exceptions_1_1_invalid_parameter_exception.html">RmExceptions::InvalidParameterException</a>( <span class="stringliteral">"RmBayesCertaintyGrid::updateRegion"</span>, 
00237                         <span class="stringliteral">"Null boundary specification"</span> );
00238 
00239         <span class="comment">// Allocate buffer for building log string to be returned</span>
00240         <span class="keyword">struct </span>PointList* interiorPointList = 
00241                 FillPolygon( polygon, 0, region == RmBayesSonarModel::RegionI ? NONCONVEX : CONVEX, 0, 0 );
00242         <span class="keywordtype">int</span> numPoints = 0;
00243         <span class="keywordflow">for</span> ( <span class="keyword">struct </span>PointList* ipl = interiorPointList; ipl; ipl = ipl-&gt;next ) ++numPoints;
00244         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffLen = numPoints * 17;    <span class="comment">// 17 chars per entry</span>
00245         <span class="keywordtype">char</span>* buff = <span class="keyword">new</span> <span class="keywordtype">char</span>[buffLen + 1];     <span class="comment">// plus one terminating null</span>
00246         buff[0] = 0;                                            <span class="comment">// initialize to zero-length string</span>
00247         <span class="keywordtype">char</span>* buffPtr = buff;
00248 
00249         assert( strlen( buff ) &lt;= buffLen );
00250 
00251         <span class="keywordflow">for</span> ( ; interiorPointList; interiorPointList = interiorPointList-&gt;next )
00252         {
00253                 <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> gcCell( interiorPointList-&gt;point.X, interiorPointList-&gt;point.Y );
00254 
00255                 <span class="comment">// Calculate quadrant-relative angle of the cell</span>
00256                 <span class="comment">// sin(theta) = dy / r  =&gt;  theta = arcsin( dy / r )</span>
00257                 <span class="keyword">const</span> <span class="keywordtype">int</span> dx = gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a> - gcSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>;
00258                 <span class="keyword">const</span> <span class="keywordtype">int</span> dy = gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> - gcSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>;
00259                 <span class="keywordtype">double</span> r = sqrt( pow( dx, 2 ) + pow( dy, 2 ) );
00260                 <span class="keywordflow">if</span> ( r &gt; m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#o0">R</a> ) r = m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#o0">R</a>;
00261                 <span class="keyword">const</span> <span class="keywordtype">double</span> thcos = dy / r;
00262                 <span class="keyword">const</span> <span class="keywordtype">double</span> acosCell = acos( thcos );
00263                 <span class="keywordtype">double</span> thCell = acosCell / RmUtility::RadianFactor;
00264                 <span class="keywordflow">if</span> ( dx &lt; 0 ) thCell = 360 - thCell;
00265 
00266                 <span class="comment">// Calculate distance between the two angles (alpha in the sonar model).</span>
00267                 <span class="comment">// Note that due to course granularity of grid cells (especially for small range readings),</span>
00268                 <span class="comment">// some cells along border of cone will actually be outside the 30 degree cone.</span>
00269                 <span class="comment">// Testing showed approximately 0.12% of the cells fall into this category.</span>
00270                 <span class="comment">// The options are to treat these like they are on the boundary of the cone or to ignore them.</span>
00271                 <span class="keywordtype">double</span> alpha = fabs( thAxis - thCell );
00272                 <span class="keywordflow">if</span> ( alpha &gt; m_settings-&gt;<a class="code" href="struct_rm_settings.html#o1">Beta</a> ) alpha = m_settings-&gt;<a class="code" href="struct_rm_settings.html#o1">Beta</a>;
00273 
00274                 <span class="comment">// Update the probability</span>
00275                 <span class="keywordflow">try</span> {
00276                         <span class="keywordtype">float</span> &amp;pr = <a class="code" href="class_rm_mutable_cartesian_grid.html#a18">valueAt</a>( gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> );
00277                         pr = m_sonarModel.<a class="code" href="class_rm_bayes_sonar_model.html#a0">prOccupiedGivenSn</a>( pr, region, r, alpha );
00278                         sprintf( buffPtr, <span class="stringliteral">"%d %d %.4f;"</span>, gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, gcCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, pr );
00279                         buffPtr += strlen( buffPtr );
00280 
00281                         <span class="keywordflow">if</span> ( strlen( buffPtr ) &gt; 17 ) {
00282                                 std::cerr &lt;&lt; <span class="stringliteral">"Error: "</span> &lt;&lt; strlen( buff ) &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; buff &lt;&lt; <span class="stringliteral">"\n"</span> &lt;&lt; gcCell &lt;&lt; std::endl;
00283                         }
00284                 }
00285                 <span class="keywordflow">catch</span>( <a class="code" href="struct_rm_exceptions_1_1_exception.html">RmExceptions::Exception</a> e ) {
00286                         std::cerr &lt;&lt; <span class="stringliteral">"Exception caught in RmBayesCertaintyGrid::updateRegion(): "</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00287                 }
00288         }
00289 
00290         <span class="keywordflow">if</span> ( strlen( buff ) &gt; buffLen ) {
00291                 std::cerr &lt;&lt; <span class="stringliteral">"Error: "</span> &lt;&lt; strlen( buffPtr ) &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; buffPtr &lt;&lt; <span class="stringliteral">"\n"</span> &lt;&lt; strlen( buff ) &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; buff &lt;&lt; std::endl;
00292                 assert( strlen( buff ) &lt;= buffLen );
00293         }
00294         std::string logString( buff );
00295         <span class="keyword">delete</span>[] buff;
00296 
00297         <span class="keywordflow">return</span> logString;
00298 }
00299 
00300 
<a name="l00301"></a><a class="code" href="class_rm_bayes_certainty_grid.html#b0">00301</a> RmBayesSonarModel::Region <a class="code" href="class_rm_bayes_certainty_grid.html#b0">RmBayesCertaintyGrid::cellRegion</a>( <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; coordSonar,
00302         <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; coordObject, <span class="keyword">const</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>&amp; coordCell )<span class="keyword"> const</span>
00303 <span class="keyword"></span>{
00304         <span class="comment">// Get distance from object to cell</span>
00305         <span class="comment">// sqrt[ (x1 - x2)^2 + (y1 - y2)^2 ]</span>
00306         <span class="keywordtype">double</span> distToObject = sqrt( pow( coordSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a> - coordObject.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, 2 ) + 
00307                 pow( coordSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> - coordObject.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, 2 ) );
00308         
00309         <span class="comment">// Get distance from robot to cell</span>
00310         <span class="keywordtype">double</span> distToCell = sqrt( pow( coordSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a> - coordCell.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a>, 2 ) + 
00311                 pow( coordSonar.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> - coordCell.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a>, 2 ) );
00312         
00313         <span class="comment">// Region: Out of range</span>
00314         <span class="keywordtype">int</span> outOfRange = RmPioneerController::SonarRange / m_settings-&gt;<a class="code" href="struct_rm_settings.html#o2">CellSize</a>;
00315         <span class="keywordflow">if</span> ( floor( distToObject ) &gt; outOfRange ) <span class="keywordflow">return</span> RmBayesSonarModel::OutOfRange;
00316         
00317         <span class="comment">// Region: III</span>
00318         <span class="keywordtype">double</span> delta = distToCell - distToObject;
00319         <span class="keywordflow">if</span> ( delta &gt; m_settings-&gt;<a class="code" href="struct_rm_settings.html#o17">RegionIHalfwidth</a> / m_settings-&gt;<a class="code" href="struct_rm_settings.html#o2">CellSize</a> ) {
00320                 <span class="keywordflow">return</span> RmBayesSonarModel::RegionIII;
00321         }
00322         
00323         <span class="comment">// Region: II</span>
00324         <span class="keywordflow">if</span> ( fabs( delta ) &gt; m_settings-&gt;<a class="code" href="struct_rm_settings.html#o17">RegionIHalfwidth</a> / m_settings-&gt;<a class="code" href="struct_rm_settings.html#o2">CellSize</a> ) {
00325                 <span class="keywordflow">return</span> RmBayesSonarModel::RegionII;
00326         }
00327         
00328         <span class="comment">// Region: I</span>
00329         <span class="keywordflow">return</span> RmBayesSonarModel::RegionI;
00330 }
00331 
00332 
<a name="l00333"></a><a class="code" href="class_rm_bayes_certainty_grid.html#b1">00333</a> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> <a class="code" href="class_rm_bayes_certainty_grid.html#b1">RmBayesCertaintyGrid::gridCoord</a>( <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a> worldCoord )<span class="keyword"> const</span>
00334 <span class="keyword"></span>{
00335         <span class="comment">// Convert to grid coordinate scale</span>
00336         <span class="keywordtype">double</span> gcX = worldCoord.<a class="code" href="class_rm_utility_1_1_coord.html#o0">x</a> / static_cast&lt;double&gt;(m_settings-&gt;<a class="code" href="struct_rm_settings.html#o2">CellSize</a>);
00337         <span class="keywordtype">double</span> gcY = worldCoord.<a class="code" href="class_rm_utility_1_1_coord.html#o1">y</a> / static_cast&lt;double&gt;(m_settings-&gt;<a class="code" href="struct_rm_settings.html#o2">CellSize</a>);
00338         
00339         <span class="comment">// Compute the "ceiling" for negative coordinates such that the proper cell is returned</span>
00340         <span class="comment">// (if a wc falls within the cell between (-382,-383), its y-coord is actually -383;</span>
00341         <span class="comment">// if a wc falls within the cell between (382,383), it's y-coord is 382)</span>
00342         <span class="comment">// For example, (-382.2, -52.89) should map to (-383, -53)</span>
00343         <span class="comment">// whereas (382.2, 52.89) should map to (382, 52)</span>
00344         <span class="comment">// This accounts for coordinate (0,0) being the first cell over, first cell up.</span>
00345         <span class="keywordtype">int</span> x = static_cast&lt;int&gt;( floor(gcX) == gcX ? gcX : (gcX &gt; 0 ? gcX : gcX - 1) );
00346         <span class="keywordtype">int</span> y = static_cast&lt;int&gt;( floor(gcY) == gcY ? gcY : (gcY &gt; 0 ? gcY : gcY - 1) );
00347         
00348         <span class="comment">// Adjust for grid world center</span>
00349         <span class="comment">// (The m_GridCenter adjustment is made after ceiling because the sign of the </span>
00350         <span class="comment">// original coordinate is significant to the result; for example, </span>
00351         <span class="comment">// ceiling( -37.1 + 250 ) = 213; whereas, ceiling( -37.1 ) + 250 = 212).</span>
00352         <span class="keywordflow">return</span> <a class="code" href="class_rm_utility_1_1_coord.html">Coord</a>( x, y );
00353 }
00354 
00355 
00356 std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="class_rm_bayes_certainty_grid.html">RmBayesCertaintyGrid</a>&amp; grid )
00357 {
00358         <span class="keywordflow">return</span> grid.<a class="code" href="class_rm_bayes_certainty_grid.html#a4">put</a>( os );
00359 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Apr 3 16:46:53 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
