<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/main.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">src</a></div>
<h1>main.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">// main.cpp</span>
00002 <span class="comment">// The stand-alone app that maps live or pre-recorded sonar data;</span>
00003 <span class="comment">// The server side of the client-server application that allows for remote control of robot</span>
00004 <span class="comment">// and mapping functionality.</span>
00005 
00006 
00007 <span class="comment">// Disable warning C4786: "identifier was truncated to '255' characters in the debug information</span>
00008 <span class="comment">// while compiling class-template member function"</span>
00009 <span class="preprocessor">#pragma warning( disable : 4786 )</span>
00010 <span class="preprocessor"></span>
00011 
00013 
00014 
00015 <span class="preprocessor">#include &lt;fstream&gt;</span>
00016 <span class="preprocessor">#include &lt;iostream&gt;</span>
00017 <span class="preprocessor">#include &lt;string&gt;</span>
00018 <span class="preprocessor">#include &lt;string&gt;</span>
00019 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00020 
00021 <span class="preprocessor">#include "RmSonarMapper.h"</span>
00022 <span class="preprocessor">#include "RmGlobalMap.h"</span>
00023 <span class="preprocessor">#include "RmUtilityExt.h"</span>
00024 <span class="preprocessor">#include "RmExceptions.h"</span>
00025 <span class="preprocessor">#include "RmPioneerController.h"</span>
00026 <span class="preprocessor">#include "RmServer.h"</span>
00027 
00028 <span class="keyword">using</span> <span class="keyword">namespace </span>RmUtility;
00029 
00030 
00032 
00033 
00034 <span class="keywordtype">void</span> mapFromFile( <a class="code" href="structRmSettings.html">RmSettings</a> &amp;settings, std::ifstream&amp; sonarStream, <a class="code" href="classRmGlobalMap.html">RmGlobalMap</a>&amp; grid );
00035 <span class="keywordtype">void</span> mapFromRobot( <a class="code" href="structRmSettings.html">RmSettings</a> &amp;settings, std::ofstream &amp;sonarStream, std::string sonarStreamName, 
00036         <a class="code" href="classRmSonarMap.html">RmSonarMap</a> &amp;grid, <span class="keywordtype">int</span> remotePort, <span class="keywordtype">bool</span> wander );
00037 std::string newLogFile( std::ofstream &amp;sonarStream, std::string sonarStreamName, <span class="keywordtype">bool</span> reset = <span class="keyword">false</span> );
00038 
00039 
00041 
00042 
00043 <span class="keyword">const</span> std::string DataPath( <span class="stringliteral">"../data/"</span> );
00044 
00045 
00047 
00048 
00064 <span class="keywordtype">int</span> main( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[] )
00065 {
00067         <span class="comment">// Get command line arguments</span>
00068 
00069         <span class="keyword">struct </span>InvalidUsageException {
00070                 <span class="keywordtype">char</span>* message;
00071                 InvalidUsageException( <span class="keywordtype">char</span>* message_ ) : message(message_) {}
00072         };
00073 
00074         <span class="keywordtype">char</span> errMsg[50];
00075 
00076         <a class="code" href="structRmSettings.html">RmSettings</a> settings;
00077         <span class="keywordtype">bool</span> prerecorded = <span class="keyword">true</span>;
00078         <span class="keywordtype">bool</span> overwrite = <span class="keyword">false</span>;
00079         <span class="keywordtype">bool</span> wander = <span class="keyword">false</span>;
00080         <span class="keywordtype">int</span> remotePort = 0;
00081 
00082         <span class="keywordflow">try</span> {
00083                 <span class="keywordflow">if</span> ( argc &lt; 3 ) {
00084                         <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00085                 }
00086 
00087                 <span class="comment">// Process command line switches</span>
00088                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 1; i &lt; argc; i += 2 ) 
00089                 {
00090                         <span class="comment">// Sonar input filename (for processing pre-recorded sonar data)</span>
00091                         <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-si"</span> ) == 0 ) {
00092                                 <span class="keywordflow">if</span> ( i+1 == argc ) <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00093                                 settings.<a class="code" href="structRmSettings.html#o20">SonarName</a> = argv[i+1];
00094                                 prerecorded = <span class="keyword">true</span>;
00095                         }
00096 
00097                         <span class="comment">// Sonar output filename, without overwrite</span>
00098                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-so"</span> ) == 0 ) {
00099                                 <span class="keywordflow">if</span> ( i+1 == argc ) <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00100                                 settings.<a class="code" href="structRmSettings.html#o20">SonarName</a> = argv[i+1];
00101                                 prerecorded = <span class="keyword">false</span>;
00102                                 overwrite = <span class="keyword">false</span>;
00103                         }
00104 
00105                         <span class="comment">// Sonar output filename, with overwrite</span>
00106                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-soo"</span> ) == 0 ) {
00107                                 <span class="keywordflow">if</span> ( i+1 == argc ) <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00108                                 settings.<a class="code" href="structRmSettings.html#o20">SonarName</a> = argv[i+1];
00109                                 prerecorded = <span class="keyword">false</span>;
00110                                 overwrite = <span class="keyword">true</span>;
00111                         }
00112 
00113                         <span class="comment">// Wander mode</span>
00114                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-w"</span> ) == 0 ) {
00115                                 wander = <span class="keyword">true</span>;
00116                         }
00117 
00118                         <span class="comment">// Remote mode (via wireless UDP connection)</span>
00119                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-r"</span> ) == 0 ) {
00120                                 remotePort = atoi( argv[i+1] );
00121                                 <span class="keywordflow">if</span> ( remotePort &lt;= 0 ) {
00122                                         <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Invalid port specification"</span> );
00123                                 }
00124                         }
00125 
00126                         <span class="comment">// Output filename for grid map</span>
00127                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-g"</span> ) == 0 ) {
00128                                 <span class="keywordflow">if</span> ( i+1 == argc ) <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00129                                 settings.<a class="code" href="structRmSettings.html#o4">GridName</a> = argv[i+1];
00130                         }
00131 
00132                         <span class="comment">// Localize "on" or "off"</span>
00133                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-l"</span> ) == 0 ) {
00134                                 <span class="keywordflow">if</span> ( i+1 == argc ) <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00135                                 <span class="keywordflow">if</span> ( strcmp( argv[i+1], <span class="stringliteral">"off"</span> ) == 0 ) settings.<a class="code" href="structRmSettings.html#o7">Localize</a> = <span class="keyword">false</span>;
00136                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i+1], <span class="stringliteral">"on"</span> ) == 0 ) settings.<a class="code" href="structRmSettings.html#o7">Localize</a> = <span class="keyword">true</span>;
00137                         }
00138 
00139                         <span class="comment">// Sonar model "cell", "axis", or "cone" (point of return, acoustic axis, field of view)</span>
00140                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i], <span class="stringliteral">"-m"</span> ) == 0 ) {
00141                                 <span class="keywordflow">if</span> ( i+1 == argc ) <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Wrong number of arguments."</span> );
00142                                 <span class="keywordflow">if</span> ( strcmp( argv[i+1], <span class="stringliteral">"cell"</span> ) == 0 ) settings.<a class="code" href="structRmSettings.html#o19">SonarModel</a> = RmUtility::SingleCell;
00143                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i+1], <span class="stringliteral">"axis"</span> ) == 0 ) settings.<a class="code" href="structRmSettings.html#o19">SonarModel</a> = 
00144                                         RmUtility::AcousticAxis;
00145                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp( argv[i+1], <span class="stringliteral">"cone"</span> ) == 0 ) settings.<a class="code" href="structRmSettings.html#o19">SonarModel</a> = RmUtility::Cone;
00146                         }
00147 
00148                         <span class="comment">// Unidentified switch</span>
00149                         <span class="keywordflow">else</span> {
00150                                 sprintf( errMsg, <span class="stringliteral">"Invalid switch: %s"</span>, argv[i] );
00151                                 <span class="keywordflow">throw</span> InvalidUsageException( errMsg );
00152                         }
00153                 }
00154 
00155                 <span class="keywordflow">if</span> ( settings.<a class="code" href="structRmSettings.html#o20">SonarName</a> == <span class="stringliteral">""</span> ) 
00156                         <span class="keywordflow">throw</span> InvalidUsageException( <span class="stringliteral">"Missing required switch -si or -so."</span> );
00157         }
00158         <span class="keywordflow">catch</span>( InvalidUsageException &amp;iue ) {
00159                 std::cout &lt;&lt; <span class="stringliteral">"\n"</span> &lt;&lt; iue.message &lt;&lt; <span class="stringliteral">"\n"</span>;
00160                 std::cout &lt;&lt; <span class="stringliteral">"Usage:  "</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">" -si|-so|-soo sonarLogName "</span> &lt;&lt;
00161                         <span class="stringliteral">"[-w{ander} -g gridLogName -l{ocalization} on|off -m cell|axis|cone]\n"</span>;
00162                 <span class="keywordflow">return</span> 1;
00163         }
00164 
00165         <span class="comment">// Update settings file based on command line switches</span>
00166         settings.<a class="code" href="structRmSettings.html#a5">write</a>();
00167 
00168 
00170         <span class="comment">// Build the map</span>
00171 
00172         <a class="code" href="classRmGlobalMap.html">RmGlobalMap</a> map( &amp;settings );
00173 
00174         <span class="keywordflow">try</span> {
00175 
00176                 std::string sonarName( settings.<a class="code" href="structRmSettings.html#o20">SonarName</a> );
00177                 sonarName.append( <span class="stringliteral">".sd"</span> );
00178 
00180                 <span class="comment">// Map from file</span>
00181 
00182                 <span class="keywordflow">if</span> ( prerecorded ) 
00183                 {
00184                         std::ifstream sonarInStream( sonarName.c_str() );
00185                         <span class="keywordflow">if</span> ( sonarInStream.fail() ) {
00186                                 <span class="keywordflow">throw</span> <a class="code" href="structRmExceptions_1_1IOException.html">RmExceptions::IOException</a>( <span class="stringliteral">"main()"</span>, <span class="stringliteral">"Unable to read sonar data file"</span> );
00187                         }
00188                         std::cout &lt;&lt; <span class="stringliteral">"Mapping sonar data from "</span> &lt;&lt; sonarName;
00189                         <span class="keywordflow">if</span> ( settings.<a class="code" href="structRmSettings.html#o7">Localize</a> ) std::cout &lt;&lt; <span class="stringliteral">" with localization"</span>;
00190                         std::cout &lt;&lt; <span class="stringliteral">"...\n"</span>;
00191                         clock_t start = clock();
00192                         mapFromFile( settings, sonarInStream, map );
00193                         std::cout &lt;&lt; clock() - start &lt;&lt; <span class="stringliteral">"\n"</span>;
00194                 }
00195 
00196 
00198                 <span class="comment">// Map from robot</span>
00199 
00200                 <span class="keywordflow">else</span> 
00201                 {
00202                         <span class="comment">// Use ifstream to test for file existence</span>
00203                         std::ifstream ifs( sonarName.c_str() );
00204                         <span class="keywordflow">if</span> ( ifs &amp;&amp; !overwrite ) {
00205                                 std::cout &lt;&lt; <span class="stringliteral">"The file "</span> &lt;&lt; sonarName &lt;&lt; <span class="stringliteral">" already exists.  Overwrite (y/n)? "</span>;
00206                                 <span class="keywordtype">char</span> c;
00207                                 std::cin &gt;&gt; c;
00208                                 <span class="keywordflow">if</span> ( tolower( c ) == <span class="charliteral">'n'</span> ) <span class="keywordflow">return</span> 0;
00209                         }
00210                         ifs.close();
00211 
00212                         std::cout &lt;&lt; <span class="stringliteral">"Mapping sonar data from live connection"</span>;
00213                         <span class="keywordflow">if</span> ( settings.<a class="code" href="structRmSettings.html#o7">Localize</a> ) std::cout &lt;&lt; <span class="stringliteral">" with localization"</span>;
00214                         std::cout &lt;&lt; <span class="stringliteral">"...\n"</span>;
00215                         std::ofstream sonarOutStream;
00216 
00217                         mapFromRobot( settings, sonarOutStream, settings.<a class="code" href="structRmSettings.html#o20">SonarName</a>, map, remotePort, wander );
00218                 }
00219 
00220                 
00222                 <span class="comment">// Save map</span>
00223 
00224                 <span class="keywordflow">if</span> ( settings.<a class="code" href="structRmSettings.html#o4">GridName</a> != <span class="stringliteral">""</span> ) 
00225                 {
00226                         std::cout &lt;&lt; <span class="stringliteral">"Saving global map to "</span> &lt;&lt; settings.<a class="code" href="structRmSettings.html#o4">GridName</a> &lt;&lt; <span class="stringliteral">".gd\n"</span>;
00227                         std::string gridName( settings.<a class="code" href="structRmSettings.html#o4">GridName</a> );
00228                         gridName.append( <span class="stringliteral">".gd"</span> );
00229                         static_cast&lt;RmMutableCartesianGrid&lt;float&gt; &gt;(map).<a class="code" href="structRmSettings.html#a2">put</a>( gridName.c_str(), 4 );
00230                                 <span class="comment">// using put() rather than operator&lt;&lt;() in order to specify precision</span>
00231                                 <span class="comment">// cast required even though RmGlobalMap is an RmMutableCartesianGrid</span>
00232                 }
00233 
00234                 std::cout &lt;&lt; <span class="stringliteral">"\n"</span>;
00235 
00236                 map.empty();
00237         }
00238         <span class="keywordflow">catch</span>( <a class="code" href="structRmExceptions_1_1Exception.html">RmExceptions::Exception</a> e ) {
00239                 std::cout &lt;&lt; <span class="stringliteral">"\n"</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00240         }
00241         <span class="keywordflow">catch</span>( ... ) {
00242                 std::cerr &lt;&lt; <span class="stringliteral">"Uncaught Exception in main().\n"</span>;
00243                 <span class="keywordflow">throw</span>;
00244         }
00245 
00246         <span class="keywordflow">return</span> 0;
00247 }
00248 
00249 
00256 <span class="keywordtype">void</span> mapFromFile( <a class="code" href="structRmSettings.html">RmSettings</a> &amp;settings, std::ifstream&amp; sonarStream, <a class="code" href="classRmGlobalMap.html">RmGlobalMap</a>&amp; grid )
00257 {
00258         <span class="keywordtype">char</span> buffer[300];
00259         <a class="code" href="classRmSonarMapper.html">RmSonarMapper</a> sonarMapper( settings, &amp;grid );
00260 
00261         <span class="keywordflow">while</span>( sonarStream.getline( buffer, 300 ) )
00262         {
00263                 <span class="comment">// Skip comments</span>
00264                 <span class="keywordflow">if</span> ( buffer[0] == <span class="charliteral">'%'</span> ) <span class="keywordflow">continue</span>;
00265 
00266                 <span class="comment">// Map entire sonar sweep</span>
00267                 sonarMapper.mapReadings( <a class="code" href="structRmUtility_1_1SonarReading.html">SonarReading</a>( buffer ) );
00268         }
00269 
00270         grid.<a class="code" href="classRmGlobalMap.html#a4">finalize</a>();
00271 }
00272 
00273 
00296 <span class="keywordtype">void</span> mapFromRobot( <a class="code" href="structRmSettings.html">RmSettings</a> &amp;settings, std::ofstream  &amp;sonarStream, std::string sonarStreamName, 
00297         <a class="code" href="classRmSonarMap.html">RmSonarMap</a> &amp;grid, <span class="keywordtype">int</span> remotePort, <span class="keywordtype">bool</span> wander )
00298 {
00299         settings.<a class="code" href="structRmSettings.html#o7">Localize</a> = <span class="keyword">false</span>; <span class="comment">// just get sonar data; localization causes delays</span>
00300 
00301         std::vector&lt;RmActionHandler*&gt; actionHandlers;
00302 
00303         <a class="code" href="classRmSonarMapper.html">RmSonarMapper</a> sonarMapper( settings, sonarStream, &amp;grid );
00304         actionHandlers.push_back( &amp;sonarMapper );
00305 
00306         <a class="code" href="classRmPioneerController.html">RmPioneerController</a> *robot = NULL;
00307         ArActionKeydrive *keydriveAction = NULL;
00308 
00309         <span class="keywordflow">if</span> ( remotePort &gt; 0 ) 
00310         {
00311                 <a class="code" href="classRmServer.html">RmServer</a> remoteControlServer( remotePort, <span class="stringliteral">"Robot control server"</span> ); <span class="comment">// for the robot</span>
00312                 <a class="code" href="classRmServer.html">RmServer</a> remoteViewServer( remotePort + 1, <span class="stringliteral">"Map viewer server"</span> ); <span class="comment">// for the Java map viewer</span>
00313 
00314                 <span class="comment">// Establish communication with control client</span>
00315                 std::cout &lt;&lt; <span class="stringliteral">"Remote client says: "</span> &lt;&lt; remoteControlServer.getClientString() &lt;&lt; <span class="stringliteral">"\n"</span>;
00316                 remoteControlServer.sendClientReply( <span class="stringliteral">"Welcome"</span> );
00317 
00318                 std::string cmdString;
00319                 std::string replyString;
00320                 <span class="keywordtype">bool</span> quit = <span class="keyword">false</span>;
00321                 <span class="keywordtype">bool</span> remoteViewer = <span class="keyword">false</span>;
00322                 <span class="keywordflow">while</span> ( (robot == NULL || robot-&gt;<a class="code" href="classRmPioneerController.html#a3">isRunning</a>()) &amp;&amp; !quit ) 
00323                 {
00324                         <span class="comment">// Get remote control command</span>
00325                         cmdString = remoteControlServer.getClientString();
00326                         std::cout &lt;&lt; cmdString &lt;&lt; <span class="stringliteral">"\n"</span>;
00327 
00328                         <span class="keywordflow">switch</span>( cmdString.c_str()[0] )
00329                         {
00330                                 <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: <span class="comment">// connect to or disconnect from remote viewer</span>
00331                                         <span class="keywordflow">if</span> ( !remoteViewer ) {
00332                                                 std::cout &lt;&lt; <span class="stringliteral">"Awaiting handshake from Remote Control Viewer\n"</span> ;
00333                                                 std::cout &lt;&lt; <span class="stringliteral">"Remote Control Viewer says: "</span> &lt;&lt; 
00334                                                         remoteViewServer.getClientString() &lt;&lt; <span class="stringliteral">"\n"</span>;
00335                                                 remoteViewServer.sendClientReply( <span class="stringliteral">"Welcome"</span> );
00336                                                 sonarMapper.setRemoteViewServer( &amp;remoteViewServer );
00337                                                 remoteViewer = <span class="keyword">true</span>;
00338                                                 replyString = <span class="stringliteral">"Remote viewer connection established"</span>;
00339                                         }
00340 
00341                                         <span class="keywordflow">if</span> ( cmdString.length() &gt;= 3 ) {
00342                                                 replyString = <span class="stringliteral">"Viewer sonar mode set to "</span>;
00343                                                 <span class="keywordflow">switch</span>( cmdString.c_str()[2] )
00344                                                 {
00345                                                         <span class="keywordflow">case</span> <span class="charliteral">'e'</span>: <span class="comment">// cEll</span>
00346                                                                 settings.<a class="code" href="structRmSettings.html#o19">SonarModel</a> = RmUtility::SingleCell;
00347                                                                 replyString.append( <span class="stringliteral">"Single Cell"</span> );
00348                                                                 <span class="keywordflow">break</span>;
00349                                                         <span class="keywordflow">case</span> <span class="charliteral">'x'</span>: <span class="comment">// aXis</span>
00350                                                                 settings.<a class="code" href="structRmSettings.html#o19">SonarModel</a> = RmUtility::AcousticAxis;
00351                                                                 replyString.append( <span class="stringliteral">"Acoustic Axis"</span> );
00352                                                                 <span class="keywordflow">break</span>;
00353                                                         <span class="keywordflow">case</span> <span class="charliteral">'o'</span>: <span class="comment">// cOne</span>
00354                                                                 settings.<a class="code" href="structRmSettings.html#o19">SonarModel</a> = RmUtility::Cone;
00355                                                                 replyString.append( <span class="stringliteral">"Cone"</span> );
00356                                                                 <span class="keywordflow">break</span>;
00357                                                         <span class="keywordflow">case</span> <span class="charliteral">'l'</span>: <span class="comment">// cLose</span>
00358                                                                 replyString = 
00359                                                                         <span class="stringliteral">"Remote viewer connection closed. Rerun viewer application."</span>;
00360                                                                 remoteViewer = <span class="keyword">false</span>;
00361                                                                 remoteViewServer.sendClientReply( <span class="stringliteral">"reset"</span> );
00362                                                                 <span class="keywordflow">break</span>;
00363                                                 }       
00364                                         }
00365                                         <span class="keywordflow">else</span> replyString = <span class="stringliteral">"Unrecognized mode"</span>;
00366 
00367                                         remoteControlServer.sendClientReply( replyString );
00368                                         <span class="keywordflow">break</span>;
00369 
00370                                 <span class="keywordflow">case</span> <span class="charliteral">'f'</span>: <span class="comment">// forward</span>
00371                                         <span class="keywordflow">if</span> ( keydriveAction ) keydriveAction-&gt;up();
00372                                         <span class="keywordflow">break</span>;
00373 
00374                                 <span class="keywordflow">case</span> <span class="charliteral">'b'</span>: <span class="comment">// backward</span>
00375                                         <span class="keywordflow">if</span> ( keydriveAction ) keydriveAction-&gt;down();
00376                                         <span class="keywordflow">break</span>;
00377 
00378                                 <span class="keywordflow">case</span> <span class="charliteral">'l'</span>: <span class="comment">// left</span>
00379                                         <span class="keywordflow">if</span> ( keydriveAction ) keydriveAction-&gt;left();
00380                                         <span class="keywordflow">break</span>;
00381 
00382                                 <span class="keywordflow">case</span> <span class="charliteral">'r'</span>: <span class="comment">// right</span>
00383                                         <span class="keywordflow">if</span> ( keydriveAction ) keydriveAction-&gt;right();
00384                                         <span class="keywordflow">break</span>;
00385 
00386                                 <span class="keywordflow">case</span> <span class="charliteral">'s'</span>: <span class="comment">// stop</span>
00387                                         <span class="keywordflow">if</span> ( keydriveAction ) keydriveAction-&gt;space();
00388                                         <span class="keywordflow">break</span>;
00389 
00390                                 <span class="keywordflow">case</span> <span class="charliteral">'w'</span>: <span class="comment">// wander/keydrive toggle</span>
00391                                         <span class="keywordflow">if</span> ( robot ) {
00392                                                 wander = !wander;
00393                                                 robot-&gt;<a class="code" href="classRmPioneerController.html#a6">setDriveMode</a>( 
00394                                                         wander ? RmPioneerController::WANDER : RmPioneerController::KEYDRIVE );
00395                                         }
00396                                         <span class="keywordflow">break</span>;
00397 
00398                                 <span class="keywordflow">case</span> <span class="charliteral">'o'</span>: <span class="comment">// toggle robot on and off, creating new log file each time turned on</span>
00399                                         <span class="keywordflow">if</span> ( robot == NULL ) {
00400                                                 std::cerr &lt;&lt; <span class="stringliteral">"robot == NULL\n"</span>;
00401                                                 remoteControlServer.sendClientReply( 
00402                                                         newLogFile( sonarStream, sonarStreamName ) );
00403                                                 robot = <span class="keyword">new</span> <a class="code" href="classRmPioneerController.html">RmPioneerController</a>( wander, !wander, &amp;actionHandlers );
00404                                                 keydriveAction = robot-&gt;<a class="code" href="classRmPioneerController.html#a0">arKeydriveAction</a>();
00405                                         }
00406                                         <span class="keywordflow">else</span> {
00407                                                 std::cerr &lt;&lt; <span class="stringliteral">"robot != NULL\n"</span>;
00408                                                 sonarStream.close();
00409 
00410                                                 <span class="keyword">delete</span> robot;
00411                                                 robot = NULL;
00412                                                 keydriveAction = NULL;
00413 
00414                                                 <span class="keywordflow">try</span> {
00415                                                         remoteViewServer.sendClientReply( <span class="stringliteral">"reset"</span> );
00416                                                 }
00417                                                 <span class="keywordflow">catch</span> ( <a class="code" href="structRmExceptions_1_1SocketException.html">RmExceptions::SocketException</a> ) {
00418                                                         <span class="comment">// Unable to communicate with remote viewer</span>
00419                                                         <span class="comment">// Ignore</span>
00420                                                 }
00421                                         }
00422                                         <span class="keywordflow">break</span>;
00423 
00424                                 <span class="keywordflow">case</span> <span class="charliteral">'d'</span>: <span class="comment">// close current log file and create new one </span>
00425                                         sonarStreamName = DataPath + cmdString.substr(1);
00426                                         remoteControlServer.sendClientReply( 
00427                                                 newLogFile( sonarStream, sonarStreamName, <span class="keyword">true</span> ) );
00428                                         <span class="keywordflow">break</span>;
00429 
00430                                 <span class="keywordflow">case</span> <span class="charliteral">'q'</span>: <span class="comment">// quit the application</span>
00431                                         sonarStream.close();
00432                                         quit = <span class="keyword">true</span>;
00433                                         <span class="keywordflow">if</span> ( robot ) <span class="keyword">delete</span> robot;
00434                                         robot = NULL;
00435                                         keydriveAction = NULL;
00436                                         <span class="keywordflow">try</span> {
00437                                                 remoteViewServer.sendClientReply( <span class="stringliteral">"quit"</span> );
00438                                         }
00439                                         <span class="keywordflow">catch</span> ( <a class="code" href="structRmExceptions_1_1SocketException.html">RmExceptions::SocketException</a> ) {
00440                                                 <span class="comment">// Unable to communicate with remote viewer</span>
00441                                                 <span class="comment">// Ignore</span>
00442                                         }
00443                                         <span class="keywordflow">break</span>;
00444                         }
00445                 }
00446         }
00447         <span class="keywordflow">else</span>
00448         {
00449                 std::cout &lt;&lt; newLogFile( sonarStream, sonarStreamName ) &lt;&lt; <span class="stringliteral">"\n"</span>;
00450                 robot = <span class="keyword">new</span> <a class="code" href="classRmPioneerController.html">RmPioneerController</a>( wander, <span class="keyword">false</span>, &amp;actionHandlers );
00451                         <span class="comment">// this blocks, handling all robot motion control, until user presses Escape</span>
00452                         <span class="comment">// meanwhile, the actionHandlers are being called as part of the robot event cycle</span>
00453         }
00454 
00455         <span class="keywordflow">if</span> ( robot ) <span class="keyword">delete</span> robot;
00456 
00457         <span class="keywordflow">return</span>;
00458 }
00459 
00460 
00472 std::string newLogFile( std::ofstream &amp;sonarStream, std::string sonarStreamName, <span class="keywordtype">bool</span> reset )
00473 {
00474         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *dataFail = <span class="stringliteral">"Unable to open sonar file '%s' for write."</span>;
00475         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *dataOkay = <span class="stringliteral">"Sonar file '%s' successfully opened for write."</span>;
00476         <span class="keyword">static</span> <span class="keywordtype">char</span> sonarName[255];
00477         <span class="keyword">static</span> <span class="keywordtype">int</span> segment = 0;
00478 
00479         <span class="keywordflow">if</span> ( reset ) segment = 0;
00480 
00481         <span class="keywordflow">if</span> ( sonarStream.is_open() ) sonarStream.close();
00482 
00483         <span class="keywordflow">if</span> ( ++segment == 1 ) sprintf( sonarName, <span class="stringliteral">"%s.sd"</span>, sonarStreamName.c_str() );
00484         <span class="keywordflow">else</span> sprintf( sonarName, <span class="stringliteral">"%s%d.sd"</span>, sonarStreamName.c_str(), segment );
00485         sonarStream.open( sonarName );
00486 
00487         <span class="keywordtype">char</span> buff[255];
00488         sprintf( buff, sonarStream ? dataOkay : dataFail, sonarName );
00489 
00490         <span class="keywordflow">return</span> std::string( buff );
00491 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 1 23:40:03 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
