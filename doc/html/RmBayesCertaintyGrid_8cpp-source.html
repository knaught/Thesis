<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Robot Mapper: src/RmBayesCertaintyGrid.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">src</a></div>
<h1>RmBayesCertaintyGrid.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">// RmBayesCertaintyGrid.cpp</span>
00002 
00003 <span class="preprocessor">#include &lt;cmath&gt;</span>
00004 <span class="preprocessor">#include &lt;iostream&gt;</span>
00005 <span class="preprocessor">#include "RmBayesCertaintyGrid.h"</span>
00006 <span class="keyword">using</span> <a class="code" href="classRmUtility_1_1Coord.html">RmUtility::Coord</a>;
00007 <span class="preprocessor">#include "RmExceptions.h"</span>
00008 
00009 <span class="preprocessor">#define _CPP_EXTERN</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#include "../polygon/polygon.h"</span>
00011 
<a name="l00012"></a><a class="code" href="classRmBayesCertaintyGrid.html#s0">00012</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="classRmBayesCertaintyGrid.html#s0">RmBayesCertaintyGrid::InitVal</a> = 0.5f;
00013 
00014 
<a name="l00015"></a><a class="code" href="classRmBayesCertaintyGrid.html#a6">00015</a> <span class="keyword">const</span> std::string <a class="code" href="classRmBayesCertaintyGrid.html#a7">RmBayesCertaintyGrid::update</a>( <span class="keyword">const</span> <a class="code" href="structRmUtility_1_1MappedSonarReading.html">RmUtility::MappedSonarReading</a>&amp; mr )
00016 {
00017         <span class="comment">// Text that goes to the log and map viewer application</span>
00018         std::string logEntry;
00019 
00020 
00022         <span class="comment">// Ignore "disabled" sonars</span>
00023         <span class="keywordflow">if</span> ( !m_settings-&gt;<a class="code" href="structRmSettings.html#o3">EnabledSonars</a>[mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.sonarNumber] ) <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00024 
00025 
00027         <span class="comment">// Ignore or convert out of range readings</span>
00028 
00029         <span class="keywordtype">int</span> rangeReading = mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.distance;
00030         <span class="keywordtype">bool</span> isOutOfRange = <span class="keyword">false</span>; <span class="comment">// for use by cone model</span>
00031 
00032         <span class="comment">// Because Region I extends beyond the actual range reading by REGION_I_HALFWIDTH,</span>
00033         <span class="comment">// ensure that its outer boundary is within the range of the sonar because</span>
00034         <span class="comment">// RmBayesSonarModel::prOccupiedGivenSn() expects r &lt;= R</span>
00035         <span class="keywordflow">if</span> ( rangeReading &gt; RmPioneerController::SonarRange - m_settings-&gt;<a class="code" href="structRmSettings.html#o17">RegionIHalfwidth</a> ) 
00036         { 
00037                 <span class="comment">// Cone model processes </span>
00038                 <span class="keywordflow">if</span> ( m_settings-&gt;<a class="code" href="structRmSettings.html#o6">IgnoreOutOfRange</a> ) { <span class="comment">// &amp;&amp; m_settings-&gt;SonarModel != RmUtility::Cone ) {</span>
00039                         <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00040                 }
00041                 isOutOfRange = <span class="keyword">true</span>;
00042                 rangeReading = m_settings-&gt;<a class="code" href="structRmSettings.html#o15">OutOfRangeConversion</a>;
00043         }
00044 
00045 
00047         <span class="comment">// Build sonar regions</span>
00048         <span class="comment">//</span>
00049         <span class="comment">// Region I is that surrounding the object detected at some distance along the sonar axis.</span>
00050         <span class="comment">// Region II is that which lies between Region I and the origin of the sonar gcSonar.</span>
00051         <span class="comment">//               F</span>
00052         <span class="comment">//         E     O     G      Region I: B-C-D-G-F-E</span>
00053         <span class="comment">//               C            Object (range reading)</span>
00054         <span class="comment">//           B       D</span>
00055         <span class="comment">//                            Region II: A-B-C-D</span>
00056         <span class="comment">//</span>
00057         <span class="comment">//               A            Origin (sonar position)</span>
00058 
00059         <span class="comment">// Convert world coordinates to grid coordinates</span>
00060         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> gcRobot = <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.robotPose.coord );
00061         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> gcSonar = <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o2">sonarPose</a>.coord );
00062         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> gcObject = <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o0">objectCoord</a> );
00063 
00064         <span class="comment">// Find left and right boundaries of cone</span>
00065         <span class="keywordtype">double</span> thAxis = mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.robotPose.theta + 
00066                 RmPioneerController::SonarTheta[mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.sonarNumber];
00067         <span class="keywordflow">if</span> ( thAxis &gt;= 360 ) thAxis -= 360;
00068         <span class="keyword">const</span> <span class="keywordtype">double</span> thLeft = thAxis - m_settings-&gt;<a class="code" href="structRmSettings.html#o1">Beta</a>;
00069         <span class="keyword">const</span> <span class="keywordtype">double</span> thRight = thAxis + m_settings-&gt;<a class="code" href="structRmSettings.html#o1">Beta</a>;
00070         <span class="keyword">const</span> <span class="keywordtype">double</span> d1 = rangeReading - m_settings-&gt;<a class="code" href="structRmSettings.html#o17">RegionIHalfwidth</a>; <span class="comment">// dist to region I</span>
00071         <span class="keyword">const</span> <span class="keywordtype">double</span> d3 = rangeReading + m_settings-&gt;<a class="code" href="structRmSettings.html#o17">RegionIHalfwidth</a>; <span class="comment">// dist to region III</span>
00072 
00073         <span class="comment">// Create points of polygons defining regions</span>
00074         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> wcSonar( mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o2">sonarPose</a>.coord );
00075         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> a( gcSonar );
00076         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> b( <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( wcSonar.mappedTo( thLeft, d1 ) ) );
00077         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> c( <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( wcSonar.mappedTo( thAxis, d1 ) ) );
00078         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> d( <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( wcSonar.mappedTo( thRight, d1 ) ) );
00079         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> e( <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( wcSonar.mappedTo( thLeft, d3 ) ) );
00080         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> f( <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o0">objectCoord</a>.<a class="code" href="classRmUtility_1_1Coord.html#a5">mappedTo</a>( thAxis, d3 - d1 ) ) );
00081                 <span class="comment">// See note in updateAxisCell()</span>
00082         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> g( <a class="code" href="classRmBayesCertaintyGrid.html#b1">gridCoord</a>( wcSonar.mappedTo( thRight, d3 ) ) );
00083 
00084         <span class="comment">// Form the polygons for use by the polygon fill routine</span>
00085         <span class="comment">// NOTE! The order of these points is *extremely* important</span>
00086         <span class="comment">// They are a "connect-the-dots" representation of the two regional polygons</span>
00087         <span class="keyword">struct </span>Point regionI[] = 
00088                 { {b.x, b.y}, {c.x, c.y}, {d.x, d.y}, {g.x, g.y}, {f.x, f.y}, {e.x, e.y} };
00089         <span class="keyword">struct </span>Point regionII[] = { {a.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, a.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>}, {b.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, b.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>}, {c.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, c.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>}, {d.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, d.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>} };
00090 
00091 
00093         <span class="comment">// Build logfile entries</span>
00094 
00095         <span class="keyword">static</span> <span class="keywordtype">char</span> buff[77]; <span class="comment">// sprintf buffer that accommodates 19 numbers with at most 3 digits, </span>
00096                 <span class="comment">// each followed by 1 whitespace character, terminated by null (19 * 4 + 1)</span>
00097 
00098         <span class="comment">// Pose and range data</span>
00099         <span class="keyword">const</span> <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a> globalPose = <a class="code" href="structRmUtility_1_1Pose.html">RmUtility::Pose</a>( gcRobot, mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.robotPose.theta );
00100         sprintf( buff, <span class="stringliteral">"%d %d %d %d %d\n"</span>, globalPose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, globalPose.<a class="code" href="structRmUtility_1_1Pose.html#o0">coord</a>.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, 
00101                 static_cast&lt;int&gt;(globalPose.<a class="code" href="structRmUtility_1_1Pose.html#o1">theta</a>), mr.<a class="code" href="structRmUtility_1_1MappedSonarReading.html#o1">reading</a>.sonarNumber, rangeReading );
00102         logEntry.append( buff );
00103 
00104         <span class="comment">// Region fill data</span>
00105         std::string regionFill;
00106         <span class="keywordflow">switch</span>( m_settings-&gt;<a class="code" href="structRmSettings.html#o19">SonarModel</a> )
00107         {
00108                 <span class="keywordflow">case</span> RmUtility::SingleCell:
00109 
00110                         regionFill.append( <a class="code" href="classRmBayesCertaintyGrid.html#b3">updateCell</a>( 
00111                                 gcObject, static_cast&lt;double&gt;(rangeReading) / m_settings-&gt;<a class="code" href="structRmSettings.html#o2">CellSize</a> ) );
00112                         <span class="keywordflow">break</span>;
00113 
00114                 <span class="keywordflow">case</span> RmUtility::AcousticAxis:
00115 
00116                         regionFill.append( <a class="code" href="classRmBayesCertaintyGrid.html#b2">updateAxis</a>( gcSonar, gcObject, f ) );
00117                         <span class="keywordflow">break</span>;
00118 
00119                 <span class="keywordflow">case</span> RmUtility::Cone:
00120 
00121                         PointListHeader pointListI = { 6, regionI };
00122                         PointListHeader pointListII = { 4, regionII };
00123 
00124                         <span class="keywordflow">try</span> {
00125                                 <span class="keywordflow">if</span> ( !isOutOfRange ) {
00126                                         regionFill.append( 
00127                                                 <a class="code" href="classRmBayesCertaintyGrid.html#b4">updateRegion</a>( RmBayesSonarModel::RegionI, &amp;pointListI, gcSonar, thAxis ) );
00128                                 }
00129                                 regionFill.append( 
00130                                         <a class="code" href="classRmBayesCertaintyGrid.html#b4">updateRegion</a>( RmBayesSonarModel::RegionII, &amp;pointListII, gcSonar, thAxis ) );
00131                         }
00132                         <span class="keywordflow">catch</span>( <a class="code" href="structRmExceptions_1_1Exception.html">RmExceptions::Exception</a> e ) {
00133                                 std::cerr &lt;&lt; <span class="stringliteral">"Exception: "</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00134                         }
00135                         <span class="keywordflow">break</span>;
00136         }
00137         <span class="keywordflow">if</span> ( regionFill.length() == 0 ) <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00138 
00139         logEntry.append( regionFill );
00140         logEntry.append( <span class="stringliteral">"\n"</span> );
00141 
00142         <span class="keywordflow">return</span> logEntry;
00143 }
00144 
00145 
<a name="l00146"></a><a class="code" href="classRmBayesCertaintyGrid.html#b3">00146</a> std::string <a class="code" href="classRmBayesCertaintyGrid.html#b3">RmBayesCertaintyGrid::updateCell</a>( <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; gcObject, <span class="keywordtype">double</span> distance )
00147 {
00148         <span class="comment">// Update grid</span>
00149         <span class="keywordtype">float</span> &amp;pr = <a class="code" href="classRmMutableCartesianGrid.html#a18">valueAt</a>( gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> );
00150         pr = m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#a0">prOccupiedGivenSn</a>( pr, RmBayesSonarModel::RegionI, distance );
00151 
00152         <span class="comment">// Log string</span>
00153         <span class="keyword">static</span> <span class="keywordtype">char</span> buff[18]; <span class="comment">// two signed 3-digit numbers and one 6-digit float, </span>
00154                 <span class="comment">// separated by one whitespace, terminated with null (2*5 + 1*7 + 1)</span>
00155 
00156         sprintf( buff, <span class="stringliteral">"%d %d %.4f;"</span>, gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, pr );
00157         assert( strlen( buff ) &lt;= 17 );
00158         <span class="keywordflow">return</span> std::string( buff );
00159 }
00160 
00161 
00162 
<a name="l00163"></a><a class="code" href="classRmBayesCertaintyGrid.html#b2">00163</a> std::string <a class="code" href="classRmBayesCertaintyGrid.html#b2">RmBayesCertaintyGrid::updateAxis</a>( <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; gcSonar, <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; gcObject, 
00164         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">RmUtility::Coord</a>&amp; gcRegionIII )
00165 {
00166         <span class="comment">// Note: This routine maps from sonar-&gt;object-&gt;regionIII rather than sonar-&gt;regionIII</span>
00167         <span class="comment">// because line sonar-&gt;object does not always align with that drawn from sonar-&gt;regionIII</span>
00168         <span class="comment">// (due to the low granularity of the grid-world coordinates)</span>
00169         <span class="comment">// It is important that these align for purposes of filtering obstructed readings</span>
00170         <span class="comment">// (see RmGlobalMap::obstructionBetween())</span>
00171 
00172         std::string logEntry;
00173 
00174         <span class="comment">// Sonar to object</span>
00175         <span class="keywordflow">for</span> ( <span class="keyword">struct </span>PointList* linePointList = FillLine( gcSonar.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcSonar.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> ); 
00176            linePointList; linePointList = linePointList-&gt;next )
00177         {
00178                 logEntry.append( updateAxisCell( gcSonar, gcObject, 
00179                         <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>( linePointList-&gt;point.X, linePointList-&gt;point.Y ) ) );
00180         }
00181 
00182         <span class="comment">// Object to Region III</span>
00183         <span class="keywordflow">for</span> ( linePointList = FillLine( gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcObject.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, gcRegionIII.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcRegionIII.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> ); 
00184            linePointList; linePointList = linePointList-&gt;next )
00185         {
00186                 logEntry.append( updateAxisCell( gcSonar, gcObject, 
00187                         <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>( linePointList-&gt;point.X, linePointList-&gt;point.Y ) ) );
00188         }
00189 
00190         <span class="keywordflow">return</span> logEntry;
00191 }
00192 
00193 
00194 
00195 std::string RmBayesCertaintyGrid::updateAxisCell( <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> &amp;gcSonar, <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> &amp;gcObject, 
00196         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> &amp;gcCell )
00197 {
00198         <span class="keyword">static</span> <span class="keywordtype">char</span> buff[18]; <span class="comment">// sprintf buffer that accommodates two 3-digit signed numbers</span>
00199                 <span class="comment">// and one 6-digit float, each followed by one character, terminated with null </span>
00200                 <span class="comment">// (2*5 + 1*7 + 1) = 18</span>
00201 
00202         RmBayesSonarModel::Region region = <a class="code" href="classRmBayesCertaintyGrid.html#b0">cellRegion</a>( gcSonar, gcObject, gcCell );
00203         <span class="keywordflow">if</span> ( region &lt;= RmBayesSonarModel::RegionI )
00204         {
00205                 <span class="keywordtype">int</span> dx = gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> - gcSonar.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>;
00206                 <span class="keywordtype">int</span> dy = gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> - gcSonar.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>;
00207                 <span class="keywordtype">double</span> r = sqrt( pow( dx, 2 ) + pow( dy, 2 ) );
00208                 <span class="keywordflow">if</span> ( r &gt; m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#o0">R</a> ) r = m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#o0">R</a>;
00209                 <span class="keywordflow">try</span> 
00210                 {
00211                         <span class="keywordtype">float</span> &amp;pr = <a class="code" href="classRmMutableCartesianGrid.html#a18">valueAt</a>( gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> );
00212                         pr = m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#a0">prOccupiedGivenSn</a>( pr, region, r );
00213 
00214                         sprintf( buff, <span class="stringliteral">"%d %d %.4f;"</span>, gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, pr );
00215                         assert( strlen( buff ) &lt;= 17 );
00216                 }
00217                 <span class="keywordflow">catch</span>( <a class="code" href="structRmExceptions_1_1Exception.html">RmExceptions::Exception</a> e ) {
00218                         std::cerr &lt;&lt; <span class="stringliteral">"Exception caught in RmBayesCertaintyGrid::updateAxisCell(): "</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00219                 }
00220         }
00221 
00222         <span class="keywordflow">return</span> std::string( buff );
00223 }
00224 
00225 
00226 
<a name="l00227"></a><a class="code" href="classRmBayesCertaintyGrid.html#b4">00227</a> std::string <a class="code" href="classRmBayesCertaintyGrid.html#b4">RmBayesCertaintyGrid::updateRegion</a>( <span class="keyword">const</span> RmBayesSonarModel::Region region, 
00228         <span class="keyword">struct</span> PointListHeader* polygon, <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; gcSonar, <span class="keywordtype">double</span> thAxis )
00229 {
00230         <span class="keywordflow">if</span> ( region != RmBayesSonarModel::RegionI &amp;&amp; region != RmBayesSonarModel::RegionII ) 
00231                 <span class="keywordflow">throw</span> <a class="code" href="structRmExceptions_1_1InvalidParameterException.html">RmExceptions::InvalidParameterException</a>( <span class="stringliteral">"RmBayesCertaintyGrid::updateRegion"</span>, 
00232                         <span class="stringliteral">"Invalid region specification"</span> );
00233         <span class="keywordflow">if</span> ( polygon == 0 ) 
00234                 <span class="keywordflow">throw</span> <a class="code" href="structRmExceptions_1_1InvalidParameterException.html">RmExceptions::InvalidParameterException</a>( <span class="stringliteral">"RmBayesCertaintyGrid::updateRegion"</span>, 
00235                         <span class="stringliteral">"Null boundary specification"</span> );
00236 
00237         <span class="comment">// Allocate buffer for building log string to be returned</span>
00238         <span class="keyword">struct </span>PointList* interiorPointList = 
00239                 FillPolygon( polygon, 0, region == RmBayesSonarModel::RegionI ? NONCONVEX : CONVEX, 0, 0 );
00240         <span class="keywordtype">int</span> numPoints = 0;
00241         <span class="keywordflow">for</span> ( <span class="keyword">struct </span>PointList* ipl = interiorPointList; ipl; ipl = ipl-&gt;next ) ++numPoints;
00242         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffLen = numPoints * 17;    <span class="comment">// 17 chars per entry</span>
00243         <span class="keywordtype">char</span>* buff = <span class="keyword">new</span> <span class="keywordtype">char</span>[buffLen + 1];     <span class="comment">// plus one terminating null</span>
00244         buff[0] = 0;                                            <span class="comment">// initialize to zero-length string</span>
00245         <span class="keywordtype">char</span>* buffPtr = buff;
00246 
00247         assert( strlen( buff ) &lt;= buffLen );
00248 
00249         <span class="keywordflow">for</span> ( ; interiorPointList; interiorPointList = interiorPointList-&gt;next )
00250         {
00251                 <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> gcCell( interiorPointList-&gt;point.X, interiorPointList-&gt;point.Y );
00252 
00253                 <span class="comment">// Calculate quadrant-relative angle of the cell</span>
00254                 <span class="comment">// sin(theta) = dy / r  =&gt;  theta = arcsin( dy / r )</span>
00255                 <span class="keyword">const</span> <span class="keywordtype">int</span> dx = gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> - gcSonar.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>;
00256                 <span class="keyword">const</span> <span class="keywordtype">int</span> dy = gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> - gcSonar.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>;
00257                 <span class="keywordtype">double</span> r = sqrt( pow( dx, 2 ) + pow( dy, 2 ) );
00258                 <span class="keywordflow">if</span> ( r &gt; m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#o0">R</a> ) r = m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#o0">R</a>;
00259                 <span class="keyword">const</span> <span class="keywordtype">double</span> thcos = dy / r;
00260                 <span class="keyword">const</span> <span class="keywordtype">double</span> acosCell = acos( thcos );
00261                 <span class="keywordtype">double</span> thCell = acosCell / RmUtility::RadianFactor;
00262                 <span class="keywordflow">if</span> ( dx &lt; 0 ) thCell = 360 - thCell;
00263 
00264                 <span class="comment">// Calculate distance between the two angles (alpha in the sonar model).</span>
00265                 <span class="comment">// Note that due to course granularity of grid cells (especially for small range readings),</span>
00266                 <span class="comment">// some cells along border of cone will actually be outside the 30 degree cone.</span>
00267                 <span class="comment">// Testing showed approximately 0.12% of the cells fall into this category.</span>
00268                 <span class="comment">// The options are to treat these like they are on the boundary of the cone or to ignore them.</span>
00269                 <span class="keywordtype">double</span> alpha = fabs( thAxis - thCell );
00270                 <span class="keywordflow">if</span> ( alpha &gt; m_settings-&gt;<a class="code" href="structRmSettings.html#o1">Beta</a> ) alpha = m_settings-&gt;<a class="code" href="structRmSettings.html#o1">Beta</a>;
00271 
00272                 <span class="comment">// Update the probability</span>
00273                 <span class="keywordflow">try</span> {
00274                         <span class="keywordtype">float</span> &amp;pr = <a class="code" href="classRmMutableCartesianGrid.html#a18">valueAt</a>( gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> );
00275                         pr = m_sonarModel.<a class="code" href="classRmBayesSonarModel.html#a0">prOccupiedGivenSn</a>( pr, region, r, alpha );
00276                         sprintf( buffPtr, <span class="stringliteral">"%d %d %.4f;"</span>, gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, gcCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, pr );
00277                         buffPtr += strlen( buffPtr );
00278 
00279                         <span class="keywordflow">if</span> ( strlen( buffPtr ) &gt; 17 ) {
00280                                 std::cerr &lt;&lt; <span class="stringliteral">"Error: "</span> &lt;&lt; strlen( buff ) &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; buff &lt;&lt; <span class="stringliteral">"\n"</span> &lt;&lt; gcCell &lt;&lt; std::endl;
00281                         }
00282                 }
00283                 <span class="keywordflow">catch</span>( <a class="code" href="structRmExceptions_1_1Exception.html">RmExceptions::Exception</a> e ) {
00284                         std::cerr &lt;&lt; <span class="stringliteral">"Exception caught in RmBayesCertaintyGrid::updateRegion(): "</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">"\n"</span>;
00285                 }
00286         }
00287 
00288         <span class="keywordflow">if</span> ( strlen( buff ) &gt; buffLen ) {
00289                 std::cerr &lt;&lt; <span class="stringliteral">"Error: "</span> &lt;&lt; strlen( buffPtr ) &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; buffPtr &lt;&lt; <span class="stringliteral">"\n"</span> &lt;&lt; strlen( buff ) &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; buff &lt;&lt; std::endl;
00290                 assert( strlen( buff ) &lt;= buffLen );
00291         }
00292         std::string logString( buff );
00293         <span class="keyword">delete</span>[] buff;
00294 
00295         <span class="keywordflow">return</span> logString;
00296 }
00297 
00298 
<a name="l00299"></a><a class="code" href="classRmBayesCertaintyGrid.html#b0">00299</a> RmBayesSonarModel::Region <a class="code" href="classRmBayesCertaintyGrid.html#b0">RmBayesCertaintyGrid::cellRegion</a>( <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; coordSonar,
00300         <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; coordObject, <span class="keyword">const</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>&amp; coordCell )<span class="keyword"> const</span>
00301 <span class="keyword"></span>{
00302         <span class="comment">// Get distance from object to cell</span>
00303         <span class="comment">// sqrt[ (x1 - x2)^2 + (y1 - y2)^2 ]</span>
00304         <span class="keywordtype">double</span> distToObject = sqrt( pow( coordSonar.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> - coordObject.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, 2 ) + 
00305                 pow( coordSonar.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> - coordObject.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, 2 ) );
00306         
00307         <span class="comment">// Get distance from robot to cell</span>
00308         <span class="keywordtype">double</span> distToCell = sqrt( pow( coordSonar.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> - coordCell.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a>, 2 ) + 
00309                 pow( coordSonar.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> - coordCell.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a>, 2 ) );
00310         
00311         <span class="comment">// Region: Out of range</span>
00312         <span class="keywordtype">int</span> outOfRange = RmPioneerController::SonarRange / m_settings-&gt;<a class="code" href="structRmSettings.html#o2">CellSize</a>;
00313         <span class="keywordflow">if</span> ( floor( distToObject ) &gt; outOfRange ) <span class="keywordflow">return</span> RmBayesSonarModel::OutOfRange;
00314         
00315         <span class="comment">// Region: III</span>
00316         <span class="keywordtype">double</span> delta = distToCell - distToObject;
00317         <span class="keywordflow">if</span> ( delta &gt; m_settings-&gt;<a class="code" href="structRmSettings.html#o17">RegionIHalfwidth</a> / m_settings-&gt;<a class="code" href="structRmSettings.html#o2">CellSize</a> ) {
00318                 <span class="keywordflow">return</span> RmBayesSonarModel::RegionIII;
00319         }
00320         
00321         <span class="comment">// Region: II</span>
00322         <span class="keywordflow">if</span> ( fabs( delta ) &gt; m_settings-&gt;<a class="code" href="structRmSettings.html#o17">RegionIHalfwidth</a> / m_settings-&gt;<a class="code" href="structRmSettings.html#o2">CellSize</a> ) {
00323                 <span class="keywordflow">return</span> RmBayesSonarModel::RegionII;
00324         }
00325         
00326         <span class="comment">// Region: I</span>
00327         <span class="keywordflow">return</span> RmBayesSonarModel::RegionI;
00328 }
00329 
00330 
<a name="l00331"></a><a class="code" href="classRmBayesCertaintyGrid.html#b1">00331</a> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> <a class="code" href="classRmBayesCertaintyGrid.html#b1">RmBayesCertaintyGrid::gridCoord</a>( <a class="code" href="classRmUtility_1_1Coord.html">Coord</a> worldCoord )<span class="keyword"> const</span>
00332 <span class="keyword"></span>{
00333         <span class="comment">// Convert to grid coordinate scale</span>
00334         <span class="keywordtype">double</span> gcX = worldCoord.<a class="code" href="classRmUtility_1_1Coord.html#o0">x</a> / static_cast&lt;double&gt;(m_settings-&gt;<a class="code" href="structRmSettings.html#o2">CellSize</a>);
00335         <span class="keywordtype">double</span> gcY = worldCoord.<a class="code" href="classRmUtility_1_1Coord.html#o1">y</a> / static_cast&lt;double&gt;(m_settings-&gt;<a class="code" href="structRmSettings.html#o2">CellSize</a>);
00336         
00337         <span class="comment">// Compute the "ceiling" for negative coordinates such that the proper cell is returned</span>
00338         <span class="comment">// (if a wc falls within the cell between (-382,-383), its y-coord is actually -383;</span>
00339         <span class="comment">// if a wc falls within the cell between (382,383), it's y-coord is 382)</span>
00340         <span class="comment">// For example, (-382.2, -52.89) should map to (-383, -53)</span>
00341         <span class="comment">// whereas (382.2, 52.89) should map to (382, 52)</span>
00342         <span class="comment">// This accounts for coordinate (0,0) being the first cell over, first cell up.</span>
00343         <span class="keywordtype">int</span> x = static_cast&lt;int&gt;( floor(gcX) == gcX ? gcX : (gcX &gt; 0 ? gcX : gcX - 1) );
00344         <span class="keywordtype">int</span> y = static_cast&lt;int&gt;( floor(gcY) == gcY ? gcY : (gcY &gt; 0 ? gcY : gcY - 1) );
00345         
00346         <span class="comment">// Adjust for grid world center</span>
00347         <span class="comment">// (The m_GridCenter adjustment is made after ceiling because the sign of the </span>
00348         <span class="comment">// original coordinate is significant to the result; for example, </span>
00349         <span class="comment">// ceiling( -37.1 + 250 ) = 213; whereas, ceiling( -37.1 ) + 250 = 212).</span>
00350         <span class="keywordflow">return</span> <a class="code" href="classRmUtility_1_1Coord.html">Coord</a>( x, y );
00351 }
00352 
00353 
00354 std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="classRmBayesCertaintyGrid.html">RmBayesCertaintyGrid</a>&amp; grid )
00355 {
00356         <span class="keywordflow">return</span> grid.<a class="code" href="classRmBayesCertaintyGrid.html#a4">put</a>( os );
00357 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 1 23:40:03 2005 for Robot Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
